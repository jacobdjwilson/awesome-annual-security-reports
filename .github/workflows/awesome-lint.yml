name: Awesome Lint

on:
  push:
    paths:
      - 'README.md'
  pull_request:
    paths:
      - 'README.md'
  workflow_dispatch:

permissions: read-all

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ðŸ“¦ Install awesome-lint
        run: npm install --global awesome-lint
        
      # Run lint check and capture errors
      - name: ðŸ” Run awesome-lint and process errors
        id: lint_check
        run: |
          awesome-lint > lint_output.txt || true
          cat lint_output.txt
          
          # Use awk to parse the output and create annotations
          awk -F '[:âœ–]' '/âœ–/ {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $1);
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2);
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $3);
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $4);
            
            # The message is the 4th field onwards
            message=$4;
            for(i=5; i<=NF; i++) {
              message = message ":" $i
            }
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", message);

            print "::error file=" $1 ",line=" $2 ",col=" $3 "::" message
          }' lint_output.txt
      
      # Check for lint ignore directives
      - name: â„¹ï¸ Check if lint exceptions exist
        run: |
          if grep -q "lint ignore" README.md; then
            echo "Note: README.md contains lint ignore directives. This is expected for certain cases."
          fi
      
      # Final check - fail the workflow if linting failed
      - name: ðŸ“Š Determine workflow status
        id: status_check
        run: |
          if grep -q "âœ–" lint_output.txt; then
            echo "lint_status=failed" >> $GITHUB_OUTPUT
            echo "::error::Linting failed. Please fix the errors shown above."
            exit 1
          else
            echo "lint_status=succeeded" >> $GITHUB_OUTPUT
            echo "âœ… Linting succeeded!"
          fi

      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## ðŸ§¹ Awesome Lint Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.status_check.outputs.lint_status }}" == "succeeded" ]; then
            echo "### âœ… Linting Succeeded" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The \`README.md\` file passed all linting checks." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Linting Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Linting errors were found in \`README.md\`. Please review the workflow logs for details and fix the issues." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Detected Errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat lint_output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "If these are expected issues, consider adding appropriate lint ignore directives." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow Run - https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
