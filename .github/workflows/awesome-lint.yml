name: Awesome Lint

on:
  push:
    paths:
      - 'README.md'
  pull_request:
    paths:
      - 'README.md'
  workflow_dispatch:

permissions: read-all

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install awesome-lint
        run: npm install --global awesome-lint

      - name: Run awesome-lint
        id: lint_check
        run: |
          awesome-lint > lint_output.txt || true
          cat lint_output.txt

          # Parse output and create annotations
          awk -F '[:‚úñ]' '/‚úñ/ {
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $1);
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2);
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $3);
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $4);

            message=$4;
            for(i=5; i<=NF; i++) {
              message = message ":" $i
            }
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", message);

            print "::error file=" $1 ",line=" $2 ",col=" $3 "::" message
          }' lint_output.txt

      - name: Check for lint ignore directives
        run: |
          if grep -q "lint ignore" README.md; then
            echo "‚ÑπÔ∏è README.md contains lint ignore directives ‚Äî this is expected for some entries."
          fi

      - name: Determine workflow status
        id: status_check
        run: |
          if grep -q "‚úñ" lint_output.txt; then
            echo "lint_status=failed" >> $GITHUB_OUTPUT
            ERROR_COUNT=$(grep -c "‚úñ" lint_output.txt || echo "0")
            echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
            echo "::error::Linting failed with $ERROR_COUNT error(s). See annotations above."
            exit 1
          else
            echo "lint_status=succeeded" >> $GITHUB_OUTPUT
            echo "error_count=0" >> $GITHUB_OUTPUT
            echo "‚úÖ Linting succeeded!"
          fi

      - name: Generate step summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          STATUS="${{ steps.status_check.outputs.lint_status }}"
          ERROR_COUNT="${{ steps.status_check.outputs.error_count }}"

          echo "## üßπ Awesome Lint" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${ERROR_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$STATUS" == "succeeded" ]; then
            echo "### ‚úÖ Lint Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`README.md\` passed all awesome-lint checks." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Lint Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${ERROR_COUNT:-0}** error(s) found in \`README.md\`. Review the annotations in the [workflow run]($RUN_URL) for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>üîç Lint Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "If these are expected issues, add appropriate \`lint ignore\` directives to \`README.md\`." >> $GITHUB_STEP_SUMMARY
          fi