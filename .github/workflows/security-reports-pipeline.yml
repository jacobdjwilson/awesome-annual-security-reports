name: Security Reports Processing Pipeline

on:
  push:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  pull_request:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  schedule:
    - cron: '0 12 * * *'  # 7:00 AM ET daily
  workflow_dispatch:
    inputs:
      year_filter:
        description: 'Process PDFs from specific year'
        required: false
        type: string
      category_filter:
        description: 'Process PDFs from specific category'
        required: false
        type: choice
        options:
          - ''
          - '2020'
          - '2021'
          - '2022'
          - '2023'
          - '2024'
          - '2025'
          - '2026'
      organization_filter:
        description: 'Process PDFs matching organization'
        required: false
        type: string
      limit_count:
        description: 'Limit files to process'
        required: false
        type: string
      skip_virus_scan:
        description: 'Skip VirusTotal scanning'
        required: false
        default: false
        type: boolean
      skip_existing_conversions:
        description: 'Skip files with existing conversions'
        required: false
        default: true
        type: boolean

concurrency:
  group: security-pipeline-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: write
  pull-requests: write

jobs:
  discover-and-scan:
    runs-on: ubuntu-latest
    outputs:
      has_files: ${{ steps.find-files.outputs.has_files }}
      scan_mode: ${{ steps.find-files.outputs.scan_mode }}
      file_count: ${{ steps.find-files.outputs.file_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load workflow configuration
        id: load_config
        run: |
          MAX_SIZE_MB=$(jq -r '.workflow.discovery.max_file_size_mb' .github/artifacts/workflow-config.json)
          DEFAULT_LIMIT=$(jq -r '.workflow.discovery.default_limit' .github/artifacts/workflow-config.json)
          PDF_MAGIC=$(jq -r '.workflow.discovery.pdf_magic_number' .github/artifacts/workflow-config.json)
          PDF_SOURCE=$(jq -r '.workflow.folders.pdf_source' .github/artifacts/workflow-config.json)
          MD_FOLDER=$(jq -r '.workflow.folders.markdown_conversions' .github/artifacts/workflow-config.json)
          MAX_AGE_DAYS=$(jq -r '.workflow.conversion.max_age_days' .github/artifacts/workflow-config.json)

          echo "max_size_mb=$MAX_SIZE_MB" >> $GITHUB_OUTPUT
          echo "default_limit=$DEFAULT_LIMIT" >> $GITHUB_OUTPUT
          echo "pdf_magic=$PDF_MAGIC" >> $GITHUB_OUTPUT
          echo "pdf_source=$PDF_SOURCE" >> $GITHUB_OUTPUT
          echo "md_folder=$MD_FOLDER" >> $GITHUB_OUTPUT
          echo "max_age_days=$MAX_AGE_DAYS" >> $GITHUB_OUTPUT

          echo "‚úì Loaded configuration:"
          echo "  Max file size : $MAX_SIZE_MB MB"
          echo "  Default limit : $DEFAULT_LIMIT"
          echo "  PDF source    : $PDF_SOURCE"
          echo "  MD folder     : $MD_FOLDER"
          echo "  Max age days  : $MAX_AGE_DAYS"

      - name: Find and validate PDF files
        id: find-files
        env:
          MAX_SIZE_MB: ${{ steps.load_config.outputs.max_size_mb }}
          DEFAULT_LIMIT: ${{ steps.load_config.outputs.default_limit }}
          PDF_MAGIC: ${{ steps.load_config.outputs.pdf_magic }}
          PDF_SOURCE: ${{ steps.load_config.outputs.pdf_source }}
          MD_FOLDER: ${{ steps.load_config.outputs.md_folder }}
          MAX_AGE_DAYS: ${{ steps.load_config.outputs.max_age_days }}
        run: |
          > files_to_process.txt
          > invalid_files.txt

          echo "======================================================================"
          echo "FILE DISCOVERY"
          echo "======================================================================"

          # Determine scan mode
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Mode: Manual"
            echo "scan_mode=manual" >> $GITHUB_OUTPUT

            FIND_CMD="find '$PDF_SOURCE' -name '*.pdf' -type f"

            if [ -n "${{ github.event.inputs.year_filter }}" ]; then
              YEAR="${{ github.event.inputs.year_filter }}"
              FIND_CMD="$FIND_CMD -path '*/$YEAR/*'"
            fi

            if [ -n "${{ github.event.inputs.category_filter }}" ]; then
              CAT="${{ github.event.inputs.category_filter }}"
              FIND_CMD="$FIND_CMD -path '*/$CAT/*'"
            fi

            eval $FIND_CMD > all_found.txt

            if [ -n "${{ github.event.inputs.organization_filter }}" ]; then
              ORG="${{ github.event.inputs.organization_filter }}"
              grep -i "$ORG" all_found.txt > filtered.txt || true
              mv filtered.txt all_found.txt
            fi

            if [ "${{ github.event.inputs.skip_existing_conversions }}" == "true" ]; then
              > needs_conversion.txt
              while IFS= read -r pdf_path; do
                md_path=$(echo "$pdf_path" | sed "s|$PDF_SOURCE|$MD_FOLDER|" | sed 's/\.pdf$/.md/')
                if [ ! -f "$md_path" ]; then
                  echo "$pdf_path" >> needs_conversion.txt
                fi
              done < all_found.txt
              mv needs_conversion.txt all_found.txt
            fi

            LIMIT="${{ github.event.inputs.limit_count }}"
            if [ -z "$LIMIT" ]; then
              LIMIT="$DEFAULT_LIMIT"
            fi

            head -n "$LIMIT" all_found.txt > files_to_process.txt

          elif [ "${{ github.event_name }}" == "schedule" ]; then
            echo "Mode: Scheduled"
            echo "scan_mode=scheduled" >> $GITHUB_OUTPUT

            find "$PDF_SOURCE" -name "*.pdf" -type f > all_pdfs.txt

            > needs_conversion.txt
            while IFS= read -r pdf_path; do
              md_path=$(echo "$pdf_path" | sed "s|$PDF_SOURCE|$MD_FOLDER|" | sed 's/\.pdf$/.md/')
              if [ ! -f "$md_path" ]; then
                # No markdown yet ‚Äî needs conversion
                echo "$pdf_path" >> needs_conversion.txt
              else
                # Markdown exists ‚Äî skip if refreshed within MAX_AGE_DAYS
                md_age=$(( ( $(date +%s) - $(date -r "$md_path" +%s) ) / 86400 ))
                if [ "$md_age" -gt "$MAX_AGE_DAYS" ]; then
                  echo "$pdf_path" >> needs_conversion.txt
                fi
              fi
            done < all_pdfs.txt

            if [ -s needs_conversion.txt ]; then
              # Process the single oldest eligible file per scheduled run
              sort -t/ -k1,1 needs_conversion.txt | head -n 1 > files_to_process.txt
            fi

          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "Mode: Push"
            echo "scan_mode=push" >> $GITHUB_OUTPUT

            ADDED=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep "$PDF_SOURCE/.*\.pdf$" || true)
            DELETED=$(git diff --name-only --diff-filter=D HEAD~1 HEAD | grep "$PDF_SOURCE/.*\.pdf$" || true)

            if [ -z "$ADDED" ] && [ -n "$DELETED" ]; then
              echo "‚äò Only deletions detected ‚Äî nothing to process"
              echo "scan_mode=push_delete_only" >> $GITHUB_OUTPUT
            elif [ -n "$ADDED" ]; then
              echo "$ADDED" > files_to_process.txt
            fi

          else
            echo "Mode: Pull request"
            echo "scan_mode=pr" >> $GITHUB_OUTPUT

            ADDED=$(git diff --name-only --diff-filter=A origin/main...HEAD | grep "$PDF_SOURCE/.*\.pdf$" || true)
            DELETED=$(git diff --name-only --diff-filter=D origin/main...HEAD | grep "$PDF_SOURCE/.*\.pdf$" || true)

            if [ -z "$ADDED" ] && [ -n "$DELETED" ]; then
              echo "‚äò Only deletions detected ‚Äî nothing to process"
              echo "scan_mode=pr_delete_only" >> $GITHUB_OUTPUT
            elif [ -n "$ADDED" ]; then
              echo "$ADDED" > files_to_process.txt
            fi
          fi

          # Validate files
          if [ -s files_to_process.txt ]; then
            VALID_FILES=""
            MAX_SIZE_BYTES=$((MAX_SIZE_MB * 1024 * 1024))

            while IFS= read -r FILE_PATH; do
              if [ ! -f "$FILE_PATH" ]; then
                echo "$FILE_PATH|File Not Found" >> invalid_files.txt
                continue
              fi

              FILE_SIZE=$(stat -c%s "$FILE_PATH")
              if [ "$FILE_SIZE" -gt "$MAX_SIZE_BYTES" ]; then
                SIZE_MB=$((FILE_SIZE/1024/1024))
                echo "$FILE_PATH|Size Limit Exceeded ($SIZE_MB MB > $MAX_SIZE_MB MB)" >> invalid_files.txt
                continue
              fi

              MAGIC=$(head -c 4 "$FILE_PATH" || true)
              if [ "$MAGIC" != "$PDF_MAGIC" ]; then
                echo "$FILE_PATH|Invalid PDF (Magic: '$MAGIC')" >> invalid_files.txt
                continue
              fi

              VALID_FILES="$VALID_FILES$FILE_PATH\n"
              echo "‚úì Valid: $FILE_PATH"
            done < files_to_process.txt

            echo -e "$VALID_FILES" | sed '/^$/d' > files_to_process.txt
          fi

          # Set outputs
          if [ -s files_to_process.txt ]; then
            FILE_COUNT=$(wc -l < files_to_process.txt)
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "‚úì $FILE_COUNT files to process"
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
            echo "‚äò No files to process"
          fi

      - name: Upload file lists
        if: steps.find-files.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: file-lists
          path: |
            files_to_process.txt
            invalid_files.txt

      - name: Generate discovery summary
        if: always()
        run: |
          SCAN_MODE="${{ steps.find-files.outputs.scan_mode }}"
          FILE_COUNT="${{ steps.find-files.outputs.file_count }}"

          echo "## üîç File Discovery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | \`${SCAN_MODE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Found | ${FILE_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$SCAN_MODE" == *"delete_only" ]]; then
            echo "‚äò **Skipped** ‚Äî changeset contained only PDF deletions. No processing needed." >> $GITHUB_STEP_SUMMARY
          elif [ -s files_to_process.txt ]; then
            echo "**Files to Process:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat files_to_process.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚äò No new PDF files detected in this changeset." >> $GITHUB_STEP_SUMMARY
          fi

          if [ -s invalid_files.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**‚ö†Ô∏è Invalid Files Skipped:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat invalid_files.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  virus-total-scan:
    runs-on: ubuntu-latest
    needs: discover-and-scan
    if: needs.discover-and-scan.outputs.has_files == 'true'
    outputs:
      scan_passed: ${{ steps.vt-scan.outputs.scan_passed }}
      scan_skipped: ${{ steps.vt-scan.outputs.scan_skipped }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download file list
        uses: actions/download-artifact@v4
        with:
          name: file-lists

      - name: Install dependencies
        run: pip install --break-system-packages requests

      - name: Run VirusTotal scan
        id: vt-scan
        env:
          VIRUS_TOTAL_API_KEY: ${{ secrets.VIRUS_TOTAL_API_KEY }}
        run: |
          SCAN_MODE="${{ needs.discover-and-scan.outputs.scan_mode }}"
          SKIP_ON_SCHEDULE=$(jq -r '.workflow.virustotal.skip_on_schedule' .github/artifacts/workflow-config.json)
          SKIP_ON_PUSH=$(jq -r '.workflow.virustotal.skip_on_push' .github/artifacts/workflow-config.json)
          MANUAL_SKIP="${{ github.event.inputs.skip_virus_scan }}"

          # Evaluate skip conditions
          SKIP_SCAN="false"
          if [ "$MANUAL_SKIP" == "true" ]; then
            SKIP_SCAN="true"
            echo "‚äò VirusTotal scan skipped (manual override)"
          elif [ "$SCAN_MODE" == "scheduled" ] && [ "$SKIP_ON_SCHEDULE" == "true" ]; then
            SKIP_SCAN="true"
            echo "‚äò VirusTotal scan skipped (scheduled run ‚Äî configured in workflow-config.json)"
          elif [[ "$SCAN_MODE" == "push"* ]] && [ "$SKIP_ON_PUSH" == "true" ]; then
            SKIP_SCAN="true"
            echo "‚äò VirusTotal scan skipped (push run ‚Äî configured in workflow-config.json)"
          fi

          if [ "$SKIP_SCAN" == "true" ]; then
            echo "scan_passed=true" >> $GITHUB_OUTPUT
            echo "scan_skipped=true" >> $GITHUB_OUTPUT
            echo '[]' > scan_results.json
            exit 0
          fi

          if [ -z "$VIRUS_TOTAL_API_KEY" ]; then
            echo "‚ö† VIRUS_TOTAL_API_KEY not set ‚Äî skipping scan"
            echo "scan_passed=true" >> $GITHUB_OUTPUT
            echo "scan_skipped=true" >> $GITHUB_OUTPUT
            echo '[]' > scan_results.json
            exit 0
          fi

          python .github/scripts/virus-total-scan.py \
            files_to_process.txt \
            --output-json scan_results.json

          echo "scan_skipped=false" >> $GITHUB_OUTPUT

          # Fail the job if any file is Malicious
          MALICIOUS=$(jq '[.[] | select(.verdict == "Malicious")] | length' scan_results.json)
          if [ "$MALICIOUS" -gt 0 ]; then
            echo "‚ùå $MALICIOUS file(s) flagged as Malicious ‚Äî blocking pipeline"
            echo "scan_passed=false" >> $GITHUB_OUTPUT
          else
            echo "scan_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: scan_results.json

      - name: Generate VirusTotal summary
        if: always()
        run: |
          echo "## üõ°Ô∏è VirusTotal Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.vt-scan.outputs.scan_skipped }}" == "true" ]; then
            SCAN_MODE="${{ needs.discover-and-scan.outputs.scan_mode }}"
            MANUAL_SKIP="${{ github.event.inputs.skip_virus_scan }}"
            if [ "$MANUAL_SKIP" == "true" ]; then
              echo "‚äò Scan skipped by manual input." >> $GITHUB_STEP_SUMMARY
            else
              echo "‚äò Scan skipped for \`${SCAN_MODE}\` mode (configured in workflow-config.json)." >> $GITHUB_STEP_SUMMARY
            fi
          elif [ -f scan_results.json ] && [ "$(jq 'length' scan_results.json)" -gt 0 ]; then
            echo "| File | Verdict | Detections | Engines | Report |" >> $GITHUB_STEP_SUMMARY
            echo "|------|---------|------------|---------|--------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | select(.status == "success") |
              "| \(.file) | \(.verdict) | \(.malicious_count + .suspicious_count) | \(.total_engines) | [View](\(.report_url)) |"
            ' scan_results.json >> $GITHUB_STEP_SUMMARY

            FAILED=$(jq '[.[] | select(.status != "success")] | length' scan_results.json)
            if [ "${FAILED:-0}" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**‚ö†Ô∏è Failed scans:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.[] | select(.status != "success") | "- \(.file // "unknown"): \(.reason // "unknown error")"' scan_results.json >> $GITHUB_STEP_SUMMARY
            fi

            MALICIOUS=$(jq '[.[] | select(.verdict == "Malicious")] | length' scan_results.json)
            if [ "$MALICIOUS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ùå **$MALICIOUS file(s) flagged as Malicious ‚Äî pipeline blocked.**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è No scan results available." >> $GITHUB_STEP_SUMMARY
          fi

  convert-pdf-to-markdown:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, virus-total-scan]
    if: |
      needs.discover-and-scan.outputs.has_files == 'true' &&
      needs.virus-total-scan.outputs.scan_passed == 'true'
    outputs:
      successful_count: ${{ steps.converter.outputs.successful_count }}
      failed_count: ${{ steps.converter.outputs.failed_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download file list
        uses: actions/download-artifact@v4
        with:
          name: file-lists

      - name: Load configuration and install dependencies
        run: |
          SYS_PACKAGES=$(jq -r '.workflow.conversion.system_packages | join(" ")' .github/artifacts/workflow-config.json)
          PY_PACKAGES=$(jq -r '.workflow.conversion.python_packages | join(" ")' .github/artifacts/workflow-config.json)

          echo "Installing system packages: $SYS_PACKAGES"
          sudo apt-get update
          sudo apt-get install -y $SYS_PACKAGES

          echo "Installing Python packages: $PY_PACKAGES"
          pip install --break-system-packages $PY_PACKAGES

      - name: Run PDF converter
        id: converter
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          MD_FOLDER=$(jq -r '.workflow.folders.markdown_conversions' .github/artifacts/workflow-config.json)

          python .github/scripts/pdf-converter.py \
            --file-list files_to_process.txt \
            --output-json conversions.json \
            --artifacts-dir .github/artifacts

          SUCCESSFUL=$(jq '[.[] | select(.status == "success")] | length' conversions.json)
          FAILED=$(jq '[.[] | select(.status != "success")] | length' conversions.json)

          echo "successful_count=$SUCCESSFUL" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT

      - name: Upload conversions
        uses: actions/upload-artifact@v4
        with:
          name: conversion-results
          path: conversions.json

      - name: Upload markdown files
        uses: actions/upload-artifact@v4
        with:
          name: markdown-conversions
          path: "Markdown Conversions/"
          if-no-files-found: ignore

      - name: Generate conversion summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          SUCCESSFUL="${{ steps.converter.outputs.successful_count }}"
          FAILED="${{ steps.converter.outputs.failed_count }}"
          MD_FOLDER=$(jq -r '.workflow.folders.markdown_conversions' .github/artifacts/workflow-config.json)

          echo "## üìÑ PDF ‚Üí Markdown Conversion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Result | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Successful | ${SUCCESSFUL:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | ${FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f conversions.json ] && [ "${FAILED:-0}" -gt 0 ]; then
            echo "**Failed conversions:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | select(.status != "success") | "\(.pdf_path): \(.error // "unknown error")"' conversions.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "üìé Conversion details available in [workflow artifacts]($RUN_URL)." >> $GITHUB_STEP_SUMMARY

  analyze-reports:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, convert-pdf-to-markdown]
    if: needs.discover-and-scan.outputs.has_files == 'true'
    outputs:
      analysis_success: ${{ steps.report-analysis.outputs.analysis_success }}
      analysis_count: ${{ steps.report-analysis.outputs.analysis_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download conversions
        uses: actions/download-artifact@v4
        with:
          name: conversion-results

      - name: Download markdown files
        uses: actions/download-artifact@v4
        with:
          name: markdown-conversions
          path: "Markdown Conversions/"

      - name: Pre-analysis verification
        id: verify
        run: |
          MIN_SIZE=$(jq -r '.workflow.validation.min_json_size_bytes' .github/artifacts/workflow-config.json)

          if [ ! -f conversions.json ]; then
            echo "‚ùå conversions.json not found"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s conversions.json)
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "‚ùå conversions.json too small ($FILE_SIZE < $MIN_SIZE bytes)"
            exit 1
          fi

          if ! jq empty conversions.json 2>/dev/null; then
            echo "‚ùå Invalid JSON in conversions.json"
            exit 1
          fi

          SUCCESSFUL=$(jq '[.[] | select(.status == "success")] | length' conversions.json)
          if [ "$SUCCESSFUL" -eq 0 ]; then
            echo "has_successful=false" >> $GITHUB_OUTPUT
            echo "‚äò No successful conversions to analyze"
            exit 0
          fi

          echo "has_successful=true" >> $GITHUB_OUTPUT
          echo "‚úì Verification passed ‚Äî $SUCCESSFUL conversions ready for analysis"

      - name: Install dependencies
        if: steps.verify.outputs.has_successful == 'true'
        run: |
          PY_PACKAGES=$(jq -r '.workflow.analysis.python_packages | join(" ")' .github/artifacts/workflow-config.json)
          pip install --break-system-packages $PY_PACKAGES

      - name: Run report analyzer
        id: report-analysis
        if: steps.verify.outputs.has_successful == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/scripts/report-analyzer.py \
            conversions.json \
            --output-json analysis.json \
            --artifacts-dir .github/artifacts

          if [ -f analysis.json ]; then
            ANALYSIS_COUNT=$(jq 'length' analysis.json)
            echo "analysis_success=true" >> $GITHUB_OUTPUT
            echo "analysis_count=$ANALYSIS_COUNT" >> $GITHUB_OUTPUT
            echo "‚úì Analyzed $ANALYSIS_COUNT reports"
          else
            echo "analysis_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload analysis
        if: steps.verify.outputs.has_successful == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: analysis.json

      - name: Generate analysis summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COUNT="${{ steps.report-analysis.outputs.analysis_count }}"

          echo "## üß† Report Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outputs.has_successful }}" != "true" ]; then
            echo "‚äò No successful conversions available for analysis." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.report-analysis.outputs.analysis_success }}" == "true" ]; then
            echo "| Organization | Title | Year | Category | Type |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|------|----------|------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "| \(.organization) | \(.title) | \(.year) | \(.category) | \(.type // "‚Äî") |"' analysis.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìé Full analysis available in [workflow artifacts]($RUN_URL)." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Analysis failed. Check [workflow logs]($RUN_URL) for details." >> $GITHUB_STEP_SUMMARY
          fi

  update-readme:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, virus-total-scan, convert-pdf-to-markdown, analyze-reports]
    if: |
      needs.discover-and-scan.outputs.has_files == 'true' &&
      needs.virus-total-scan.outputs.scan_passed == 'true' &&
      needs.analyze-reports.outputs.analysis_success == 'true'
    outputs:
      readme_updated: ${{ steps.readme_update.outputs.readme_updated }}
      pr_number: ${{ steps.create_pr.outputs.pull-request-number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download analysis
        uses: actions/download-artifact@v4
        with:
          name: analysis-results

      - name: Download scan results
        uses: actions/download-artifact@v4
        with:
          name: scan-results

      - name: Download markdown files
        uses: actions/download-artifact@v4
        with:
          name: markdown-conversions
          path: "Markdown Conversions/"

      - name: Update README
        id: readme_update
        env:
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        run: |
          VALIDATE_TOC=$(jq -r '.workflow.validation.validate_toc' .github/artifacts/workflow-config.json)

          if [ "$VALIDATE_TOC" == "true" ]; then
            python .github/scripts/readme-updater.py \
              analysis.json \
              --readme-path README.md \
              --artifacts-dir .github/artifacts \
              --validate-toc
          else
            python .github/scripts/readme-updater.py \
              analysis.json \
              --readme-path README.md \
              --artifacts-dir .github/artifacts
          fi

          if git diff --quiet README.md "Markdown Conversions/"; then
            echo "readme_updated=false" >> $GITHUB_OUTPUT
            echo "‚äò No changes to commit"
          else
            echo "readme_updated=true" >> $GITHUB_OUTPUT
            echo "‚úì Changes detected"
          fi

      - name: Generate PR content
        id: generate_pr
        if: steps.readme_update.outputs.readme_updated == 'true'
        run: |
          BRANCH_PREFIX=$(jq -r '.workflow.pull_request.branch_prefix' .github/artifacts/workflow-config.json)
          SINGLE_TEMPLATE=$(jq -r '.workflow.pull_request.single_report_title_template' .github/artifacts/workflow-config.json)
          MULTI_TEMPLATE=$(jq -r '.workflow.pull_request.multiple_report_title_template' .github/artifacts/workflow-config.json)
          LABELS=$(jq -r '.workflow.pull_request.labels | join("\n")' .github/artifacts/workflow-config.json)

          REPORT_COUNT=$(jq 'length' analysis.json)

          if [ "$REPORT_COUNT" -eq 1 ]; then
            ORG=$(jq -r '.[0].organization' analysis.json)
            TITLE=$(jq -r '.[0].title' analysis.json)
            YEAR=$(jq -r '.[0].year' analysis.json)
            PR_TITLE=$(echo "$SINGLE_TEMPLATE" | sed "s/{organization}/$ORG/" | sed "s/{title}/$TITLE/" | sed "s/{year}/$YEAR/")
          else
            PR_TITLE=$(echo "$MULTI_TEMPLATE" | sed "s/{count}/$REPORT_COUNT/")
          fi

          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_PREFIX}${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "labels<<EOF" >> $GITHUB_OUTPUT
          echo "$LABELS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Generate PR body
          SCAN_MODE="${{ needs.discover-and-scan.outputs.scan_mode }}"
          CONV_OK="${{ needs.convert-pdf-to-markdown.outputs.successful_count }}"
          CONV_FAIL="${{ needs.convert-pdf-to-markdown.outputs.failed_count }}"
          VT_SKIPPED="${{ needs.virus-total-scan.outputs.scan_skipped }}"

          {
            echo "## üìä Security Reports Update"
            echo ""
            echo "**Mode:** \`$SCAN_MODE\`  **Reports:** $REPORT_COUNT"
            echo ""

            echo "### üìÑ Reports"
            echo ""
            jq -r '.[] | "#### \(.organization) ‚Äî \(.title) (\(.year))\n\n**Category:** \(.category)  **Type:** \(.type // "‚Äî")\n\n**Summary:** \(.summary)\n\n---\n"' analysis.json
            echo ""

            echo "### üõ°Ô∏è VirusTotal"
            echo ""
            if [ "$VT_SKIPPED" == "true" ]; then
              echo "Scan skipped for this run mode."
            elif [ -f scan_results.json ] && [ "$(jq 'length' scan_results.json)" -gt 0 ]; then
              echo "| File | Verdict | Detections | Report |"
              echo "|------|---------|------------|--------|"
              jq -r '.[] | select(.status == "success") | "| \(.file) | \(.verdict) | \(.malicious_count + .suspicious_count)/\(.total_engines) | [View](\(.report_url)) |"' scan_results.json
            else
              echo "No scan results."
            fi
            echo ""

            echo "### üìà Conversions"
            echo ""
            echo "- Successful: $CONV_OK  Failed: $CONV_FAIL"
            echo ""
            echo "---"
            echo "*Auto-generated by Security Reports Pipeline ¬∑ [Run #${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
          } > pr_body.md

      - name: Create Pull Request
        id: create_pr
        if: steps.readme_update.outputs.readme_updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "${{ steps.generate_pr.outputs.pr_title }}"
          title: "${{ steps.generate_pr.outputs.pr_title }}"
          body-path: pr_body.md
          branch: ${{ steps.generate_pr.outputs.branch_name }}
          delete-branch: true
          labels: ${{ steps.generate_pr.outputs.labels }}
          add-paths: |
            README.md
            Markdown Conversions/

      - name: Generate README update summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PR_NUM="${{ steps.create_pr.outputs.pull-request-number }}"
          VT_SKIPPED="${{ needs.virus-total-scan.outputs.scan_skipped }}"

          echo "## üìù README Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.readme_update.outputs.readme_updated }}" == "true" ]; then
            if [ -n "$PR_NUM" ]; then
              PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUM"
              echo "‚úÖ Pull request created: [PR #$PR_NUM]($PR_URL)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ README updated (PR creation may have been skipped or is pending)." >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f analysis.json ]; then
              echo "**Changes:**" >> $GITHUB_STEP_SUMMARY
              echo "| Organization | Title | Year | Category |" >> $GITHUB_STEP_SUMMARY
              echo "|-------------|-------|------|----------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.[] | "| \(.organization) | \(.title) | \(.year) | \(.category) |"' analysis.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚äò No changes detected ‚Äî README is already up to date." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VirusTotal:** $([ "$VT_SKIPPED" == "true" ] && echo "Skipped" || echo "Passed ‚úÖ")" >> $GITHUB_STEP_SUMMARY