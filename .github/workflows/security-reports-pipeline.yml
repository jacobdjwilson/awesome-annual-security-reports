name: Security Reports Processing Pipeline

on:
  push:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  
  pull_request:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  
  schedule:
    - cron: '0 12 * * *'
  
  workflow_dispatch:
    inputs:
      year_filter:
        description: 'Process PDFs from specific year'
        required: false
        type: string
      
      category_filter:
        description: 'Process PDFs from specific category'
        required: false
        type: choice
        options:
          - ''
          - '2020'
          - '2021'
          - '2022'
          - '2023'
          - '2024'
          - '2025'
          - '2026'
      
      organization_filter:
        description: 'Process PDFs matching organization'
        required: false
        type: string
      
      limit_count:
        description: 'Limit files to process (default: 10)'
        required: false
        default: '10'
        type: string
      
      skip_virus_scan:
        description: 'Skip VirusTotal scanning'
        required: false
        default: false
        type: boolean
      
      skip_existing_conversions:
        description: 'Skip files with existing conversions'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  discover-and-scan:
    runs-on: ubuntu-latest
    outputs:
      files_to_process: ${{ steps.find-files.outputs.files_to_process }}
      has_files: ${{ steps.find-files.outputs.has_files }}
      scan_mode: ${{ steps.find-files.outputs.scan_mode }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and validate PDF files
        id: find-files
        run: |
          > files_to_process.txt
          > deleted_files.txt
          
          echo "======================================================================"
          echo "FILE DISCOVERY"
          echo "======================================================================"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Mode: Manual with filters"
            echo "scan_mode=manual" >> $GITHUB_OUTPUT
            
            FIND_CMD="find 'Annual Security Reports' -name '*.pdf' -type f"
            
            if [ -n "${{ github.event.inputs.year_filter }}" ]; then
              YEAR="${{ github.event.inputs.year_filter }}"
              FIND_CMD="$FIND_CMD -path '*/$YEAR/*'"
              echo "Filter: Year = $YEAR"
            fi
            
            if [ -n "${{ github.event.inputs.category_filter }}" ]; then
              CAT="${{ github.event.inputs.category_filter }}"
              FIND_CMD="$FIND_CMD -path '*/$CAT/*'"
              echo "Filter: Category = $CAT"
            fi
            
            eval $FIND_CMD > all_found.txt
            
            if [ -n "${{ github.event.inputs.organization_filter }}" ]; then
              ORG="${{ github.event.inputs.organization_filter }}"
              grep -i "$ORG" all_found.txt > filtered.txt || true
              mv filtered.txt all_found.txt
              echo "Filter: Organization = $ORG"
            fi
            
            if [ "${{ github.event.inputs.skip_existing_conversions }}" == "true" ]; then
              > needs_conversion.txt
              while IFS= read -r pdf_path; do
                md_path=$(echo "$pdf_path" | sed 's/Annual Security Reports/Markdown Conversions/' | sed 's/\.pdf$/.md/')
                if [ ! -f "$md_path" ]; then
                  echo "$pdf_path" >> needs_conversion.txt
                fi
              done < all_found.txt
              mv needs_conversion.txt all_found.txt
              echo "Filter: Skip existing = enabled"
            fi
            
            LIMIT="${{ github.event.inputs.limit_count }}"
            if [ -z "$LIMIT" ]; then
              LIMIT=10
            fi
            
            head -n "$LIMIT" all_found.txt > files_to_process.txt
            echo "Filter: Limit = $LIMIT files"
            
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            echo "Mode: Scheduled"
            echo "scan_mode=scheduled" >> $GITHUB_OUTPUT
            
            find "Annual Security Reports" -name "*.pdf" -type f > all_pdfs.txt
            
            > missing_conversions.txt
            while IFS= read -r pdf_path; do
              md_path=$(echo "$pdf_path" | sed 's/Annual Security Reports/Markdown Conversions/' | sed 's/\.pdf$/.md/')
              if [ ! -f "$md_path" ]; then
                echo "$pdf_path" >> missing_conversions.txt
              fi
            done < all_pdfs.txt
            
            if [ -s missing_conversions.txt ]; then
              cat missing_conversions.txt | xargs ls -rt | head -n 1 > files_to_process.txt
            fi
            
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "Mode: Push"
            echo "scan_mode=push" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep 'Annual Security Reports/.*\.pdf$' > files_to_process.txt || true
            git diff --name-only --diff-filter=D HEAD~1 HEAD | grep 'Annual Security Reports/.*\.pdf$' > deleted_files.txt || true
            
          else
            echo "Mode: Pull request"
            echo "scan_mode=pr" >> $GITHUB_OUTPUT
            git diff --name-only --diff-filter=AM origin/main...HEAD | grep 'Annual Security Reports/.*\.pdf$' > files_to_process.txt || true
            git diff --name-only --diff-filter=D origin/main...HEAD | grep 'Annual Security Reports/.*\.pdf$' > deleted_files.txt || true
          fi
          
          # Validate files
          if [ -s files_to_process.txt ]; then
            VALID_FILES=""
            
            while IFS= read -r FILE_PATH; do
              if [ ! -f "$FILE_PATH" ]; then
                echo "âŠ˜ Not found: $FILE_PATH"
                continue
              fi
              
              FILE_SIZE=$(stat -c%s "$FILE_PATH")
              if [ "$FILE_SIZE" -gt 104857600 ]; then
                echo "âŠ˜ Too large: $FILE_PATH"
                continue
              fi
              
              MAGIC=$(head -c 4 "$FILE_PATH" || true)
              if [ "$MAGIC" != "%PDF" ]; then
                echo "âŠ˜ Invalid PDF: $FILE_PATH"
                continue
              fi
              
              VALID_FILES="$VALID_FILES$FILE_PATH\n"
              echo "âœ“ Valid: $FILE_PATH"
            done < files_to_process.txt
            
            echo -e "$VALID_FILES" | sed '/^$/d' > files_to_process.txt
          fi
          
          if [ -s files_to_process.txt ]; then
            FILE_COUNT=$(wc -l < files_to_process.txt)
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "files_to_process=$(cat files_to_process.txt | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
            echo "âœ“ $FILE_COUNT files to process"
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "âŠ˜ No files to process"
          fi

      - name: Upload file list
        if: steps.find-files.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: file-lists
          path: |
            files_to_process.txt
            deleted_files.txt

  convert-pdf-to-markdown:
    runs-on: ubuntu-latest
    needs: discover-and-scan
    if: needs.discover-and-scan.outputs.has_files == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download file list
        uses: actions/download-artifact@v4
        with:
          name: file-lists

      - name: Install dependencies
        run: |
          # Install system dependencies for markitdown
          sudo apt-get update
          sudo apt-get install -y \
            poppler-utils \
            tesseract-ocr \
            libtesseract-dev \
            libleptonica-dev
          
          # Install Python packages
          pip install --break-system-packages \
            "markitdown[pdf,ocr]" \
            "pypdf[crypto]" \
            google-generativeai \
            google-ai-generativelanguage \
            Pillow \
            pytesseract

      - name: Run PDF converter
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/scripts/pdf-converter.py \
            --file-list files_to_process.txt \
            --output-json conversions.json \
            --artifacts-dir .github/artifacts
          
          # Check for partial conversions
          PARTIAL=$(jq '[.[] | select(.message | contains("partial"))] | length' conversions.json)
          
          if [ "$PARTIAL" -gt 0 ]; then
            echo "âš ï¸ WARNING: $PARTIAL partial conversion(s)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Conversion Warnings" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | select(.message | contains("partial")) | 
              "- **\(.organization_name)**: \(.message)"' conversions.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload conversions
        uses: actions/upload-artifact@v4
        with:
          name: conversion-results
          path: conversions.json

      - name: Upload markdown files
        uses: actions/upload-artifact@v4
        with:
          name: markdown-conversions
          path: Markdown Conversions/
          if-no-files-found: ignore

  analyze-reports:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, convert-pdf-to-markdown]
    if: needs.discover-and-scan.outputs.has_files == 'true'
    outputs:
      analysis_success: ${{ steps.report-analysis.outputs.analysis_success }}
      analysis_count: ${{ steps.report-analysis.outputs.analysis_count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download conversions
        uses: actions/download-artifact@v4
        with:
          name: conversion-results

      - name: Download markdown files
        uses: actions/download-artifact@v4
        with:
          name: markdown-conversions
          path: Markdown Conversions/

      - name: Install dependencies
        run: |
          pip install --break-system-packages \
            google-generativeai \
            google-ai-generativelanguage

      - name: Run report analyzer
        id: report-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "Running report analyzer..."
          
          if [ ! -f conversions.json ]; then
            echo "ERROR: conversions.json not found"
            exit 1
          fi
          
          successful_count=$(jq '[.[] | select(.status == "success")] | length' conversions.json)
          echo "Successful conversions: $successful_count"
          
          if [ "$successful_count" -eq 0 ]; then
            echo "No successful conversions"
            echo "analysis_success=false" >> $GITHUB_OUTPUT
            echo "analysis_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          python .github/scripts/report-analyzer.py \
            conversions.json \
            --output-json analysis.json \
            --artifacts-dir .github/artifacts
          
          if [ -f analysis.json ]; then
            analysis_count=$(jq 'length' analysis.json)
            echo "analysis_success=true" >> $GITHUB_OUTPUT
            echo "analysis_count=$analysis_count" >> $GITHUB_OUTPUT
            echo "âœ“ Analyzed $analysis_count reports"
          else
            echo "ERROR: analysis.json not created"
            echo "analysis_success=false" >> $GITHUB_OUTPUT
            echo "analysis_count=0" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload analysis
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: analysis.json

  update-readme:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, convert-pdf-to-markdown, analyze-reports]
    if: |
      needs.discover-and-scan.outputs.has_files == 'true' &&
      needs.analyze-reports.outputs.analysis_success == 'true'
    outputs:
      readme_updated: ${{ steps.readme_update.outputs.readme_updated }}
      pr_number: ${{ steps.create_pr.outputs.pull-request-number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download analysis
        uses: actions/download-artifact@v4
        with:
          name: analysis-results

      - name: Download markdown files
        uses: actions/download-artifact@v4
        with:
          name: markdown-conversions
          path: Markdown Conversions/

      - name: Update README
        id: readme_update
        run: |
          echo "Updating README..."
          
          python .github/scripts/readme-updater.py \
            analysis.json \
            --readme-path README.md \
            --artifacts-dir .github/artifacts
          
          # Check for changes
          if git diff --quiet README.md "Markdown Conversions/"; then
            echo "readme_updated=false" >> $GITHUB_OUTPUT
            echo "âŠ˜ No changes (entries already exist)"
          else
            echo "readme_updated=true" >> $GITHUB_OUTPUT
            echo "âœ“ README updated"
          fi

      - name: Create Pull Request
        id: create_pr
        if: steps.readme_update.outputs.readme_updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ“„ Update security reports"
          title: "Update Security Reports - ${{ needs.analyze-reports.outputs.analysis_count }} Report(s)"
          body: |
            ## ðŸ“Š Security Reports Update
            
            **Processed:** ${{ needs.analyze-reports.outputs.analysis_count }} report(s)
            **Mode:** ${{ needs.discover-and-scan.outputs.scan_mode }}
            
            ### Changes
            - âœ… Updated markdown conversions
            - âœ… Updated README with report entries
            
            ### Reports Included
            See analysis artifact for details.
            
            ---
            *Auto-generated by Security Reports Pipeline*
          branch: security-reports-update-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            security-reports
          add-paths: |
            README.md
            Markdown Conversions/

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ needs.discover-and-scan.outputs.scan_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Files processed:** ${{ needs.analyze-reports.outputs.analysis_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**README updated:** ${{ steps.readme_update.outputs.readme_updated }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.readme_update.outputs.readme_updated }}" == "true" ]; then
            if [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
              echo "### âœ… Pull Request Created" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**PR #${{ steps.create_pr.outputs.pull-request-number }}**: Ready for review" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "[View Pull Request](https://github.com/${{ github.repository }}/pull/${{ steps.create_pr.outputs.pull-request-number }})" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ No Updates Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All processed reports already exist in README with current year." >> $GITHUB_STEP_SUMMARY
          fi