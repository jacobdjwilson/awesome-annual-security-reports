name: Security Reports Processing Pipeline

on:
  push:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  pull_request:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      force_scan_all:
        description: 'Force scan all PDF files (not just changed)'
        required: false
        default: false
        type: boolean
      skip_virus_scan:
        description: 'Skip VirusTotal scanning'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  discover-and-scan:
    runs-on: ubuntu-latest
    outputs:
      files_to_process: ${{ steps.find-files.outputs.files_to_process }}
      has_files: ${{ steps.find-files.outputs.has_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and Validate PDF files
        id: find-files
        run: |
          > files_to_process.txt
          > deleted_files.txt

          if [[ "${{ github.event.inputs.force_scan_all }}" == "true" ]]; then
            echo "mode: Force Scan All"
            find "Annual Security Reports" -name "*.pdf" > files_to_process.txt
          
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            echo "mode: Scheduled Catch-up"
            
            find "Annual Security Reports" -name "*.pdf" -type f > all_pdfs.txt
            
            > missing_conversions.txt
            while IFS= read -r pdf_path; do
                md_path=$(echo "$pdf_path" | sed 's/Annual Security Reports/Markdown Conversions/' | sed 's/\.pdf$/.md/')
                
                if [ ! -f "$md_path" ]; then
                    echo "$pdf_path" >> missing_conversions.txt
                fi
            done < all_pdfs.txt

            if [ -s missing_conversions.txt ]; then
                count=$(wc -l < missing_conversions.txt)
                echo "Found $count files pending conversion."
                
                cat missing_conversions.txt | xargs ls -rt | head -n 1 > files_to_process.txt
                
                echo "Selected oldest unprocessed file: $(cat files_to_process.txt)"
            else
                echo "âœ… No backlog found. All PDFs have corresponding Markdown files."
            fi

          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "mode: Push Event"
            git diff --name-only HEAD~1 HEAD | grep 'Annual Security Reports/.*\.pdf$' > files_to_process.txt || true
            git diff --name-only --diff-filter=D HEAD~1 HEAD | grep 'Annual Security Reports/.*\.pdf$' > deleted_files.txt || true
          
          else
            echo "mode: Pull Request"
            git diff --name-only --diff-filter=AM origin/main...HEAD | grep 'Annual Security Reports/.*\.pdf$' > files_to_process.txt || true
            git diff --name-only --diff-filter=D origin/main...HEAD | grep 'Annual Security Reports/.*\.pdf$' > deleted_files.txt || true
          fi

          # Validation
          if [ -s files_to_process.txt ]; then
            VALID_FILES=""
            INVALID_FILES=""
            while IFS= read -r FILE_PATH; do
              if [ ! -f "$FILE_PATH" ]; then
                echo "Warning: File not found: $FILE_PATH. Skipping."
                INVALID_FILES="$INVALID_FILES\n$FILE_PATH (Not Found)"
                continue
              fi

              FILE_SIZE=$(stat -c%s "$FILE_PATH")
              if [ "$FILE_SIZE" -gt 104857600 ]; then
                echo "Warning: File size ($((FILE_SIZE/1024/1024)) MB) exceeds 100MB limit for $FILE_PATH. Skipping."
                INVALID_FILES="$INVALID_FILES\n$FILE_PATH (Size Limit Exceeded)"
                continue
              fi

              MAGIC_NUMBER=$(head -c 4 "$FILE_PATH" || true)
              if [ "$MAGIC_NUMBER" != "%PDF" ]; then
                echo "Warning: File is not a valid PDF for $FILE_PATH (Magic number: '$MAGIC_NUMBER'). Skipping."
                INVALID_FILES="$INVALID_FILES\n$FILE_PATH (Invalid PDF)"
                continue
              fi

              VALID_FILES="$VALID_FILES$FILE_PATH\n"
            done < files_to_process.txt
            
            echo -e "$VALID_FILES" | sed '/^$/d' > valid_files_to_process.txt
            if [ -s valid_files_to_process.txt ]; then
              mv valid_files_to_process.txt files_to_process.txt
            else
              rm valid_files_to_process.txt
              > files_to_process.txt
            fi

            if [ ! -z "$INVALID_FILES" ]; then
              echo "### âš ï¸ Invalid Files Skipped" >> $GITHUB_STEP_SUMMARY
              echo "The following files were skipped during validation:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo -e "$INVALID_FILES" | sed '/^$/d' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ -s files_to_process.txt ]; then
            files_content=$(cat files_to_process.txt | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
            json_array="["
            first_item=true
            while IFS= read -r line; do
              line=$(echo "$line" | sed 's/,$//')
              if [ "$first_item" = false ]; then
                json_array+=,
              fi
              json_array+="\"$line\""
              first_item=false
            done <<< "$files_content"
            json_array+="]"
            echo "files_to_process=$json_array" >> $GITHUB_OUTPUT
            echo "has_files=true" >> $GITHUB_OUTPUT
            
            echo "### ðŸ“„ Files to Process" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat files_to_process.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "files_to_process=[]" >> $GITHUB_OUTPUT
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "No files found to process." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload file lists
        uses: actions/upload-artifact@v4
        with:
          name: file-lists
          path: |
            files_to_process.txt
            deleted_files.txt

  convert-pdf-to-markdown:
    runs-on: ubuntu-latest
    needs: discover-and-scan
    if: needs.discover-and-scan.outputs.has_files == 'true'
    outputs:
      conversion_success: ${{ steps.pdf-conversion.outputs.conversion_success }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download file lists
        uses: actions/download-artifact@v4
        with:
          name: file-lists
          path: .

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
          python -m pip install --upgrade pip
          pip install "pypdf[crypto]" google-genai markitdown[pdf,ocr] google-api-python-client

      - name: Determine Conversion Settings
        id: conversion-settings
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          
          if [ "$BRANCH_NAME" == "main" ]; then
            PROMPT_VERSION="v3"
            PROMPT_PATH=".github/ai-prompts/pdf-to-markdown-prompt.md"
          else
            PROMPT_VERSION="v3-dev"
            PROMPT_PATH=".github/ai-prompts/pdf-to-markdown-prompt.md"
          fi
          
          echo "prompt_path=$PROMPT_PATH" >> $GITHUB_OUTPUT
          echo "prompt_version=$PROMPT_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "Using prompt: $PROMPT_PATH (version: $PROMPT_VERSION)"

      - name: Run PDF to Markdown Conversion
        id: pdf-conversion
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PROMPT_PATH="${{ steps.conversion-settings.outputs.prompt_path }}"
          PROMPT_VERSION="${{ steps.conversion-settings.outputs.prompt_version }}"
          BRANCH_NAME="${{ steps.conversion-settings.outputs.branch_name }}"
          
          echo "Converting PDFs to Markdown..."
          echo "Prompt: $PROMPT_PATH"
          echo "Version: $PROMPT_VERSION"
          
          if python .github/scripts/pdf-converter.py files_to_process.txt "$PROMPT_PATH" "$PROMPT_VERSION" "$BRANCH_NAME" --output-json conversions.json; then
            echo "PDF conversion completed successfully"
            
            if [ -f conversions.json ]; then
              successful_count=$(jq '[.[] | select(.status == "success")] | length' conversions.json)
              total_count=$(jq 'length' conversions.json)
              
              echo "conversion_success=true" >> $GITHUB_OUTPUT
              echo "Conversion results: $successful_count successful out of $total_count"
              
              if [ "$successful_count" -eq 0 ]; then
                echo "WARNING: No PDFs were successfully converted"
                echo "conversion_success=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "ERROR: conversions.json not created"
              echo "conversion_success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "ERROR: PDF conversion failed"
            echo "conversion_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload conversion results
        uses: actions/upload-artifact@v4
        with:
          name: conversion-results
          path: conversions.json

      - name: Upload generated Markdown files
        if: steps.pdf-conversion.outputs.conversion_success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: conversion-results
          path: |
            Markdown Conversions/
            conversions.json
          retention-days: 7

  analyze-reports:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, convert-pdf-to-markdown]
    if: needs.discover-and-scan.outputs.has_files == 'true' && needs.convert-pdf-to-markdown.outputs.conversion_success == 'true'
    outputs:
      analysis_success: ${{ steps.report-analysis.outputs.analysis_success }}
      analysis_count: ${{ steps.report-analysis.outputs.analysis_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai google-api-python-client requests

      - name: Download conversion results and Markdown files
        uses: actions/download-artifact@v4
        with:
          name: conversion-results
          path: .

      - name: Verify conversions file
        run: |
          echo "=== Verifying conversions.json ==="
          
          if [ ! -f conversions.json ]; then
            echo "ERROR: conversions.json not found"
            exit 1
          fi
          
          file_size=$(stat -c%s conversions.json)
          echo "Conversion file size: $file_size bytes"
          
          if [ "$file_size" -lt 10 ]; then
            echo "ERROR: conversions.json is too small"
            exit 1
          fi
          
          echo "Conversions content preview:"
          jq '.' conversions.json || cat conversions.json
          
          successful_count=$(jq '[.[] | select(.status == "success")] | length' conversions.json)
          echo "Successful conversions found: $successful_count"
          
          if [ "$successful_count" -eq 0 ]; then
            echo "ERROR: No successful conversions to analyze"
            exit 1
          fi
          
          echo "=== Files that will be analyzed ==="
          jq -r '.[] | select(.status == "success") | .pdf_path' conversions.json

      - name: Run Report Analyzer
        id: report-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        run: |
          echo "Running report analyzer..."
          echo "IMPORTANT: Only analyzing files from conversions.json (this run only)"
          
          if python .github/scripts/report-analyzer.py \
            conversions.json \
            --readme-path README.md \
            --output-json analysis.json; then
            
            echo "Report analysis completed successfully"
            
            if [ -f analysis.json ]; then
              analysis_count=$(jq 'length' analysis.json)
              echo "analysis_success=true" >> $GITHUB_OUTPUT
              echo "analysis_count=$analysis_count" >> $GITHUB_OUTPUT
              
              echo "Analysis results: $analysis_count reports analyzed"
              
              if [ "$analysis_count" -eq 0 ]; then
                echo "WARNING: No reports were successfully analyzed"
              fi
            else
              echo "ERROR: analysis.json not created"
              echo "analysis_success=false" >> $GITHUB_OUTPUT
              echo "analysis_count=0" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "ERROR: Report analysis failed"
            echo "analysis_success=false" >> $GITHUB_OUTPUT
            echo "analysis_count=0" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: analysis.json

  update-readme:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, analyze-reports]
    if: needs.discover-and-scan.outputs.has_files == 'true' && needs.analyze-reports.outputs.analysis_success == 'true'
    outputs:
      readme_updated: ${{ steps.readme_update.outputs.readme_updated }}
      pr_created: ${{ steps.create_pr.outputs.pull-request-number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download analysis results
        uses: actions/download-artifact@v4
        with:
          name: analysis-results
          path: .

      - name: Download conversion results for README update
        uses: actions/download-artifact@v4
        with:
          name: conversion-results
          path: .

      - name: Update README
        id: readme_update
        run: |
          if python .github/scripts/readme-updater.py analysis.json --readme-path README.md; then
            if git diff --quiet HEAD -- README.md "Markdown Conversions/"; then
              echo "No changes detected in README or Markdown files"
              echo "readme_updated=false" >> $GITHUB_OUTPUT
            else
              echo "Changes detected - README or Markdown files updated"
              echo "readme_updated=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "ERROR: README updater failed"
            echo "readme_updated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate PR Body
        id: pr_body
        if: steps.readme_update.outputs.readme_updated == 'true'
        run: |
          cat > pr_body.md << 'EOF'
## ðŸ“„ Security Reports Update

This PR updates the README with the following security reports:

EOF
          
          jq -r '.[] | "### \(.organization) - \(.title) (\(.year))\n\n**Category:** \(.category)\n**Type:** \(.type)\n\n**Summary:** \(.summary)\n\n---\n"' analysis.json >> pr_body.md
          
          cat >> pr_body.md << 'EOF'

## ðŸ¤– Automated Processing

- PDF files converted to Markdown
- Reports analyzed and categorized using AI
- README updated with proper categorization
- TOC validated for consistency

**Run ID:** ${{ github.run_id }}
**Triggered by:** ${{ github.event_name }}
EOF
          
          pr_body_encoded=$(cat pr_body.md | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")
          echo "pr_body=$pr_body_encoded" >> $GITHUB_OUTPUT

      - name: Configure Git
        if: steps.readme_update.outputs.readme_updated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Generate PR Title
        id: pr_details
        if: steps.readme_update.outputs.readme_updated == 'true'
        run: |
          report_count=$(jq 'length' analysis.json)
          if [ "$report_count" -eq 1 ]; then
            org=$(jq -r '.[0].organization' analysis.json)
            title=$(jq -r '.[0].title' analysis.json)
            year=$(jq -r '.[0].year' analysis.json)
            pr_title="Add ${org} ${title} (${year}) report"
          else
            pr_title="Add ${report_count} new security reports"
          fi
          
          if [ "${{ github.event_name }}" == "schedule" ]; then
             pr_title="[Automated Catch-up] ${pr_title}"
          fi
          
          echo "pr_title=${pr_title}" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.readme_update.outputs.readme_updated == 'true'
        run: |
          git add README.md
          git add "Markdown Conversions/" || true
          git commit -m "${{ steps.pr_details.outputs.pr_title }}"

      - name: Create Pull Request
        id: create_pr
        if: steps.readme_update.outputs.readme_updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ${{ steps.pr_details.outputs.pr_title }}
          title: "ðŸ“„ ${{ steps.pr_details.outputs.pr_title }}"
          body: ${{ steps.pr_body.outputs.pr_body }}
          branch: report-update-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            readme-update
            security-reports

  generate-summary:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, convert-pdf-to-markdown, analyze-reports, update-readme]
    if: always() && needs.discover-and-scan.outputs.has_files == 'true'
    steps:
      - name: Download analysis results
        uses: actions/download-artifact@v4
        with:
          name: analysis-results
          path: .
        continue-on-error: true

      - name: Download conversion results
        uses: actions/download-artifact@v4
        with:
          name: conversion-results
          path: .
        continue-on-error: true

      - name: Generate Pipeline Summary
        run: |
          echo "## ðŸ” Security Reports Processing Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Job Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Discovery & Scan | ${{ needs.discover-and-scan.result }} | Found files: ${{ needs.discover-and-scan.outputs.has_files }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PDF Conversion | ${{ needs.convert-pdf-to-markdown.result }} | Success: ${{ needs.convert-pdf-to-markdown.outputs.conversion_success }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Report Analysis | ${{ needs.analyze-reports.result }} | Count: ${{ needs.analyze-reports.outputs.analysis_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| README Update | ${{ needs.update-readme.result }} | Updated: ${{ needs.update-readme.outputs.readme_updated }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f conversions.json ]; then
            echo "### ðŸ“ Files Processed in This Run" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| PDF File | Status | Model Used |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|---------|------------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "| \(.pdf_path | split("/") | last) | \(if .status == "success" then "âœ…" else "âŒ" end) \(.status) | \(.model_used // "N/A") |"' conversions.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No conversion results available." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f analysis.json ]; then
            echo "### ðŸ” Reports Analyzed and Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Organization | Title | Year | Category | Type |" >> $GITHUB_STEP_SUMMARY
            echo "|--------------|-------|------|----------|------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "| \(.organization // "N/A") | \(.title // "N/A") | \(.year // "N/A") | \(.category // "N/A") | \(.type // "N/A") |"' analysis.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No analysis results available." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ðŸ“‹ README Update Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.update-readme.result }}" == "success" ]; then
            if [ "${{ needs.update-readme.outputs.readme_updated }}" == "true" ]; then
              echo "âœ… README update completed successfully" >> $GITHUB_STEP_SUMMARY
              if [ -n "${{ needs.update-readme.outputs.pr_created }}" ]; then
                echo "ðŸ“‹ Pull request #${{ needs.update-readme.outputs.pr_created }} created for review" >> $GITHUB_STEP_SUMMARY
              else
                echo "ðŸ“‹ Pull request created for review" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "â„¹ï¸ No changes needed - Reports already up to date in README" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ README update failed or was skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.update-readme.result }}" == "success" ] && [ "${{ needs.update-readme.outputs.readme_updated }}" == "true" ]; then
            echo "ðŸŽ‰ **Pipeline completed successfully!** New security reports processed and README updated." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.analyze-reports.result }}" == "success" ]; then
            echo "â„¹ï¸ **Reports processed but no README changes needed.** All entries already current." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Pipeline encountered issues.** Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
          fi