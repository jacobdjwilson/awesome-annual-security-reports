name: Security Reports Processing Pipeline

on:
  push:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  pull_request:
    branches: [main, development]
    paths:
      - 'Annual Security Reports/**/*.pdf'
  schedule:
    - cron: '0 12 * * *'  # 7:00 AM ET daily
  workflow_dispatch:
    inputs:
      year_filter:
        description: 'Process PDFs from specific year'
        required: false
        type: string
      category_filter:
        description: 'Process PDFs from specific category'
        required: false
        type: choice
        options:
          - ''
          - '2020'
          - '2021'
          - '2022'
          - '2023'
          - '2024'
          - '2025'
          - '2026'
      organization_filter:
        description: 'Process PDFs matching organization'
        required: false
        type: string
      limit_count:
        description: 'Limit files to process'
        required: false
        type: string
      skip_virus_scan:
        description: 'Skip VirusTotal scanning'
        required: false
        default: false
        type: boolean
      skip_existing_conversions:
        description: 'Skip files with existing conversions'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  discover-and-scan:
    runs-on: ubuntu-latest
    outputs:
      files_to_process: ${{ steps.find-files.outputs.files_to_process }}
      has_files: ${{ steps.find-files.outputs.has_files }}
      scan_mode: ${{ steps.find-files.outputs.scan_mode }}
      file_count: ${{ steps.find-files.outputs.file_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load workflow configuration
        id: load_config
        run: |
          MAX_SIZE_MB=$(jq -r '.workflow.discovery.max_file_size_mb' .github/artifacts/workflow-config.json)
          DEFAULT_LIMIT=$(jq -r '.workflow.discovery.default_limit' .github/artifacts/workflow-config.json)
          PDF_MAGIC=$(jq -r '.workflow.discovery.pdf_magic_number' .github/artifacts/workflow-config.json)

          echo "max_size_mb=$MAX_SIZE_MB" >> $GITHUB_OUTPUT
          echo "default_limit=$DEFAULT_LIMIT" >> $GITHUB_OUTPUT
          echo "pdf_magic=$PDF_MAGIC" >> $GITHUB_OUTPUT

          echo "‚úì Loaded configuration:"
          echo "  Max file size: $MAX_SIZE_MB MB"
          echo "  Default limit: $DEFAULT_LIMIT"
          echo "  PDF magic: $PDF_MAGIC"

      - name: Find and validate PDF files
        id: find-files
        env:
          MAX_SIZE_MB: ${{ steps.load_config.outputs.max_size_mb }}
          DEFAULT_LIMIT: ${{ steps.load_config.outputs.default_limit }}
          PDF_MAGIC: ${{ steps.load_config.outputs.pdf_magic }}
        run: |
          > files_to_process.txt
          > invalid_files.txt

          echo "======================================================================"
          echo "FILE DISCOVERY"
          echo "======================================================================"

          # Determine scan mode
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Mode: Manual"
            echo "scan_mode=manual" >> $GITHUB_OUTPUT

            FIND_CMD="find 'Annual Security Reports' -name '*.pdf' -type f"

            if [ -n "${{ github.event.inputs.year_filter }}" ]; then
              YEAR="${{ github.event.inputs.year_filter }}"
              FIND_CMD="$FIND_CMD -path '*/$YEAR/*'"
            fi

            if [ -n "${{ github.event.inputs.category_filter }}" ]; then
              CAT="${{ github.event.inputs.category_filter }}"
              FIND_CMD="$FIND_CMD -path '*/$CAT/*'"
            fi

            eval $FIND_CMD > all_found.txt

            if [ -n "${{ github.event.inputs.organization_filter }}" ]; then
              ORG="${{ github.event.inputs.organization_filter }}"
              grep -i "$ORG" all_found.txt > filtered.txt || true
              mv filtered.txt all_found.txt
            fi

            if [ "${{ github.event.inputs.skip_existing_conversions }}" == "true" ]; then
              > needs_conversion.txt
              while IFS= read -r pdf_path; do
                md_path=$(echo "$pdf_path" | sed 's/Annual Security Reports/Markdown Conversions/' | sed 's/\.pdf$/.md/')
                if [ ! -f "$md_path" ]; then
                  echo "$pdf_path" >> needs_conversion.txt
                fi
              done < all_found.txt
              mv needs_conversion.txt all_found.txt
            fi

            LIMIT="${{ github.event.inputs.limit_count }}"
            if [ -z "$LIMIT" ]; then
              LIMIT="$DEFAULT_LIMIT"
            fi

            head -n "$LIMIT" all_found.txt > files_to_process.txt

          elif [ "${{ github.event_name }}" == "schedule" ]; then
            echo "Mode: Scheduled"
            echo "scan_mode=scheduled" >> $GITHUB_OUTPUT

            find "Annual Security Reports" -name "*.pdf" -type f > all_pdfs.txt

            > missing_conversions.txt
            while IFS= read -r pdf_path; do
              md_path=$(echo "$pdf_path" | sed 's/Annual Security Reports/Markdown Conversions/' | sed 's/\.pdf$/.md/')
              if [ ! -f "$md_path" ]; then
                echo "$pdf_path" >> missing_conversions.txt
              fi
            done < all_pdfs.txt

            if [ -s missing_conversions.txt ]; then
              cat missing_conversions.txt | xargs ls -rt | head -n 1 > files_to_process.txt
            fi

          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "Mode: Push"
            echo "scan_mode=push" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep 'Annual Security Reports/.*\.pdf$' > files_to_process.txt || true

          else
            echo "Mode: Pull request"
            echo "scan_mode=pr" >> $GITHUB_OUTPUT
            git diff --name-only --diff-filter=AM origin/main...HEAD | grep 'Annual Security Reports/.*\.pdf$' > files_to_process.txt || true
          fi

          # Validate files
          if [ -s files_to_process.txt ]; then
            VALID_FILES=""
            MAX_SIZE_BYTES=$((MAX_SIZE_MB * 1024 * 1024))

            while IFS= read -r FILE_PATH; do
              if [ ! -f "$FILE_PATH" ]; then
                echo "$FILE_PATH|File Not Found" >> invalid_files.txt
                continue
              fi

              FILE_SIZE=$(stat -c%s "$FILE_PATH")
              if [ "$FILE_SIZE" -gt "$MAX_SIZE_BYTES" ]; then
                SIZE_MB=$((FILE_SIZE/1024/1024))
                echo "$FILE_PATH|Size Limit Exceeded ($SIZE_MB MB > $MAX_SIZE_MB MB)" >> invalid_files.txt
                continue
              fi

              MAGIC=$(head -c 4 "$FILE_PATH" || true)
              if [ "$MAGIC" != "$PDF_MAGIC" ]; then
                echo "$FILE_PATH|Invalid PDF (Magic: '$MAGIC')" >> invalid_files.txt
                continue
              fi

              VALID_FILES="$VALID_FILES$FILE_PATH\n"
              echo "‚úì Valid: $FILE_PATH"
            done < files_to_process.txt

            echo -e "$VALID_FILES" | sed '/^$/d' > files_to_process.txt
          fi

          # Set outputs
          if [ -s files_to_process.txt ]; then
            FILE_COUNT=$(wc -l < files_to_process.txt)
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "‚úì $FILE_COUNT files to process"
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
            echo "‚äò No files to process"
          fi

      - name: Upload file lists
        if: steps.find-files.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: file-lists
          path: |
            files_to_process.txt
            invalid_files.txt

      - name: Generate discovery summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "## üîç File Discovery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | \`${{ steps.find-files.outputs.scan_mode }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Found | ${{ steps.find-files.outputs.file_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s files_to_process.txt ]; then
            echo "**Files to Process:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat files_to_process.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          if [ -s invalid_files.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**‚ö†Ô∏è Invalid Files Skipped:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat invalid_files.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  convert-pdf-to-markdown:
    runs-on: ubuntu-latest
    needs: discover-and-scan
    if: needs.discover-and-scan.outputs.has_files == 'true'
    outputs:
      successful_count: ${{ steps.converter.outputs.successful_count }}
      failed_count: ${{ steps.converter.outputs.failed_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download file list
        uses: actions/download-artifact@v4
        with:
          name: file-lists

      - name: Load configuration and install dependencies
        run: |
          SYS_PACKAGES=$(jq -r '.workflow.conversion.system_packages | join(" ")' .github/artifacts/workflow-config.json)
          PY_PACKAGES=$(jq -r '.workflow.conversion.python_packages | join(" ")' .github/artifacts/workflow-config.json)

          echo "Installing system packages: $SYS_PACKAGES"
          sudo apt-get update
          sudo apt-get install -y $SYS_PACKAGES

          echo "Installing Python packages: $PY_PACKAGES"
          pip install --break-system-packages $PY_PACKAGES

      - name: Run PDF converter
        id: converter
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/scripts/pdf-converter.py \
            --file-list files_to_process.txt \
            --output-json conversions.json \
            --artifacts-dir .github/artifacts

          SUCCESSFUL=$(jq '[.[] | select(.status == "success")] | length' conversions.json)
          FAILED=$(jq '[.[] | select(.status != "success")] | length' conversions.json)

          echo "successful_count=$SUCCESSFUL" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT

      - name: Upload conversions
        uses: actions/upload-artifact@v4
        with:
          name: conversion-results
          path: conversions.json

      - name: Upload markdown files
        uses: actions/upload-artifact@v4
        with:
          name: markdown-conversions
          path: Markdown Conversions/
          if-no-files-found: ignore

      - name: Generate conversion summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          SUCCESSFUL="${{ steps.converter.outputs.successful_count }}"
          FAILED="${{ steps.converter.outputs.failed_count }}"

          echo "## üìÑ PDF ‚Üí Markdown Conversion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Result | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Successful | ${SUCCESSFUL:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | ${FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f conversions.json ] && [ "${FAILED:-0}" -gt 0 ]; then
            echo "**Failed conversions:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | select(.status != "success") | "\(.pdf_path): \(.error // "unknown error")"' conversions.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "üìé Conversion details available in [workflow artifacts]($RUN_URL)." >> $GITHUB_STEP_SUMMARY

  analyze-reports:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, convert-pdf-to-markdown]
    if: needs.discover-and-scan.outputs.has_files == 'true'
    outputs:
      analysis_success: ${{ steps.report-analysis.outputs.analysis_success }}
      analysis_count: ${{ steps.report-analysis.outputs.analysis_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download conversions
        uses: actions/download-artifact@v4
        with:
          name: conversion-results

      - name: Download markdown files
        uses: actions/download-artifact@v4
        with:
          name: markdown-conversions
          path: Markdown Conversions/

      - name: Pre-analysis verification
        id: verify
        run: |
          MIN_SIZE=$(jq -r '.workflow.validation.min_json_size_bytes' .github/artifacts/workflow-config.json)

          if [ ! -f conversions.json ]; then
            echo "‚ùå conversions.json not found"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s conversions.json)
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "‚ùå conversions.json too small ($FILE_SIZE < $MIN_SIZE bytes)"
            exit 1
          fi

          if ! jq empty conversions.json 2>/dev/null; then
            echo "‚ùå Invalid JSON in conversions.json"
            exit 1
          fi

          SUCCESSFUL=$(jq '[.[] | select(.status == "success")] | length' conversions.json)
          if [ "$SUCCESSFUL" -eq 0 ]; then
            echo "has_successful=false" >> $GITHUB_OUTPUT
            echo "‚äò No successful conversions to analyze"
            exit 0
          fi

          echo "has_successful=true" >> $GITHUB_OUTPUT
          echo "‚úì Verification passed ‚Äî $SUCCESSFUL conversions ready for analysis"

      - name: Install dependencies
        if: steps.verify.outputs.has_successful == 'true'
        run: |
          pip install --break-system-packages \
            google-generativeai \
            google-ai-generativelanguage

      - name: Run report analyzer
        id: report-analysis
        if: steps.verify.outputs.has_successful == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/scripts/report-analyzer.py \
            conversions.json \
            --output-json analysis.json \
            --artifacts-dir .github/artifacts

          if [ -f analysis.json ]; then
            ANALYSIS_COUNT=$(jq 'length' analysis.json)
            echo "analysis_success=true" >> $GITHUB_OUTPUT
            echo "analysis_count=$ANALYSIS_COUNT" >> $GITHUB_OUTPUT
            echo "‚úì Analyzed $ANALYSIS_COUNT reports"
          else
            echo "analysis_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload analysis
        if: steps.verify.outputs.has_successful == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: analysis.json

      - name: Generate analysis summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COUNT="${{ steps.report-analysis.outputs.analysis_count }}"

          echo "## üß† Report Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outputs.has_successful }}" != "true" ]; then
            echo "‚äò No successful conversions available for analysis." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.report-analysis.outputs.analysis_success }}" == "true" ]; then
            echo "‚úÖ Successfully analyzed **${COUNT}** report(s)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f analysis.json ]; then
              echo "**Reports analyzed:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              jq -r '.[] | "\(.organization) ‚Äî \(.title) (\(.year)) [\(.category)]"' analysis.json >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìé Full analysis available in [workflow artifacts]($RUN_URL)." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Analysis failed. Check [workflow logs]($RUN_URL) for details." >> $GITHUB_STEP_SUMMARY
          fi

  update-readme:
    runs-on: ubuntu-latest
    needs: [discover-and-scan, convert-pdf-to-markdown, analyze-reports]
    if: |
      needs.discover-and-scan.outputs.has_files == 'true' &&
      needs.analyze-reports.outputs.analysis_success == 'true'
    outputs:
      readme_updated: ${{ steps.readme_update.outputs.readme_updated }}
      pr_number: ${{ steps.create_pr.outputs.pull-request-number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download analysis
        uses: actions/download-artifact@v4
        with:
          name: analysis-results

      - name: Download markdown files
        uses: actions/download-artifact@v4
        with:
          name: markdown-conversions
          path: Markdown Conversions/

      - name: Update README
        id: readme_update
        run: |
          VALIDATE_TOC=$(jq -r '.workflow.validation.validate_toc' .github/artifacts/workflow-config.json)

          if [ "$VALIDATE_TOC" == "true" ]; then
            python .github/scripts/readme-updater.py \
              analysis.json \
              --readme-path README.md \
              --artifacts-dir .github/artifacts \
              --validate-toc
          else
            python .github/scripts/readme-updater.py \
              analysis.json \
              --readme-path README.md \
              --artifacts-dir .github/artifacts
          fi

          if git diff --quiet README.md "Markdown Conversions/"; then
            echo "readme_updated=false" >> $GITHUB_OUTPUT
            echo "‚äò No changes to commit"
          else
            echo "readme_updated=true" >> $GITHUB_OUTPUT
            echo "‚úì Changes detected"
          fi

      - name: Generate PR content
        id: generate_pr
        if: steps.readme_update.outputs.readme_updated == 'true'
        run: |
          BRANCH_PREFIX=$(jq -r '.workflow.pull_request.branch_prefix' .github/artifacts/workflow-config.json)
          SINGLE_TEMPLATE=$(jq -r '.workflow.pull_request.single_report_title_template' .github/artifacts/workflow-config.json)
          MULTI_TEMPLATE=$(jq -r '.workflow.pull_request.multiple_report_title_template' .github/artifacts/workflow-config.json)

          REPORT_COUNT=$(jq 'length' analysis.json)

          if [ "$REPORT_COUNT" -eq 1 ]; then
            ORG=$(jq -r '.[0].organization' analysis.json)
            TITLE=$(jq -r '.[0].title' analysis.json)
            YEAR=$(jq -r '.[0].year' analysis.json)
            PR_TITLE=$(echo "$SINGLE_TEMPLATE" | sed "s/{organization}/$ORG/" | sed "s/{title}/$TITLE/" | sed "s/{year}/$YEAR/")
          else
            PR_TITLE=$(echo "$MULTI_TEMPLATE" | sed "s/{count}/$REPORT_COUNT/")
          fi

          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_PREFIX}${{ github.run_id }}" >> $GITHUB_OUTPUT

          # Generate PR body
          SCAN_MODE="${{ needs.discover-and-scan.outputs.scan_mode }}"
          SUCCESSFUL="${{ needs.convert-pdf-to-markdown.outputs.successful_count }}"
          FAILED="${{ needs.convert-pdf-to-markdown.outputs.failed_count }}"

          {
            echo "## üìä Security Reports Update"
            echo ""
            echo "**Mode:** \`$SCAN_MODE\`"
            echo "**Reports:** $REPORT_COUNT"
            echo ""
            echo "### üìÑ Reports Included"
            echo ""
            jq -r '.[] | "#### \(.organization) - \(.title) (\(.year))\n\n**Category:** \(.category)\n**Summary:** \(.summary)\n\n---\n"' analysis.json
            echo ""
            echo "### üìà Statistics"
            echo ""
            echo "- **Conversions:** $SUCCESSFUL successful, $FAILED failed"
            echo ""
            echo "---"
            echo "*Auto-generated by Security Reports Pipeline ¬∑ Run [#${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
          } > pr_body.md

      - name: Create Pull Request
        id: create_pr
        if: steps.readme_update.outputs.readme_updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "${{ steps.generate_pr.outputs.pr_title }}"
          title: "${{ steps.generate_pr.outputs.pr_title }}"
          body-path: pr_body.md
          branch: ${{ steps.generate_pr.outputs.branch_name }}
          delete-branch: true
          labels: |
            automated
            security-reports
          add-paths: |
            README.md
            Markdown Conversions/

      - name: Generate README update summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PR_NUM="${{ steps.create_pr.outputs.pull-request-number }}"

          echo "## üìù README Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.readme_update.outputs.readme_updated }}" == "true" ]; then
            if [ -n "$PR_NUM" ]; then
              PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUM"
              echo "‚úÖ Pull request created: [PR #$PR_NUM]($PR_URL)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ README updated (PR creation may have been skipped or is pending)." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚äò No changes detected ‚Äî README and Markdown Conversions are already up to date." >> $GITHUB_STEP_SUMMARY
          fi