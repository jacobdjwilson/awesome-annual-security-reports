name: Security Report Discovery

on:
  schedule:
    - cron: '0 11 * * *'  # 6:00 AM ET daily

  workflow_dispatch:
    inputs:
      max_discoveries:
        description: 'Maximum number of reports to discover'
        required: false
        default: '10'
        type: string

permissions:
  contents: read
  issues: write

jobs:
  discover:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --break-system-packages \
            google-api-python-client \
            beautifulsoup4 \
            requests

      - name: Load workflow configuration
        id: load_config
        run: |
          DEFAULT_LIMIT=$(jq -r '.workflow.discovery.default_limit' .github/artifacts/workflow-config.json)
          echo "default_limit=$DEFAULT_LIMIT" >> $GITHUB_OUTPUT
          echo "âœ“ Default limit: $DEFAULT_LIMIT"

      - name: Run discovery
        id: discovery
        env:
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          MAX="${{ github.event.inputs.max_discoveries }}"
          if [ -z "$MAX" ]; then
            MAX="${{ steps.load_config.outputs.default_limit }}"
          fi

          python .github/scripts/report-discovery.py \
            --artifacts-dir .github/artifacts \
            --max-discoveries "$MAX" \
            > discovery_output.log 2>&1

          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload discovery log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: discovery-log-${{ github.run_id }}
          path: discovery_output.log
          retention-days: 7

      - name: Generate step summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Parse log metrics
          SERIES_TOTAL=$(grep -c "\[" discovery_output.log 2>/dev/null || echo "0")
          SKIPPED_REPO=$(grep "series skipped" discovery_output.log 2>/dev/null | grep -oP "\d+" | head -1 || echo "0")
          SEARCHED=$(grep -c "Searching:" discovery_output.log 2>/dev/null || echo "0")
          CANDIDATES=$(grep -c "Found candidate:" discovery_output.log 2>/dev/null || echo "0")
          CREATED=$(grep -c "Created issue:" discovery_output.log 2>/dev/null || echo "0")
          SKIPPED_ISSUE=$(grep -c "already open" discovery_output.log 2>/dev/null || echo "0")

          echo "## ðŸ” Security Report Discovery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Discoveries | \`${{ github.event.inputs.max_discoveries || steps.load_config.outputs.default_limit }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Series Skipped (next year in repo) | ${SKIPPED_REPO:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Searches Run | ${SEARCHED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Candidates Found | ${CANDIDATES:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Issues Created | ${CREATED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped (issue already open) | ${SKIPPED_ISSUE:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${CREATED:-0}" -gt 0 ]; then
            echo "### âœ… New Reports Discovered" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep "Created issue:" discovery_output.log | sed 's/.*Created issue: /- /' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŠ˜ No new reports discovered this run." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ“Ž Full discovery log available in [workflow artifacts]($RUN_URL)." >> $GITHUB_STEP_SUMMARY