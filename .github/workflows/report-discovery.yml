name: Security Report Discovery

on:
  schedule:
    - cron: '0 11 * * *'  # 6:00 AM ET daily
  
  workflow_dispatch:
    inputs:
      max_discoveries:
        description: 'Maximum number of reports to discover'
        required: false
        default: '10'
        type: string

permissions:
  contents: read
  issues: write

jobs:
  discover:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --break-system-packages \
            google-api-python-client \
            beautifulsoup4 \
            requests

      - name: Run discovery
        id: discovery
        env:
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          MAX="${{ github.event.inputs.max_discoveries }}"
          if [ -z "$MAX" ]; then
            MAX=10
          fi
          
          python .github/scripts/report-discovery.py \
            --artifacts-dir .github/artifacts \
            --max-discoveries "$MAX" \
            > discovery_output.log 2>&1

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ” Security Report Discovery Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count discoveries
          DISCOVERED=$(grep -c "âœ“ Found candidate" discovery_output.log || echo "0")
          CREATED=$(grep -c "âœ“ Created issue" discovery_output.log || echo "0")
          SCANNED=$(grep -c "Searching:" discovery_output.log || echo "0")
          
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "- Scanned: $SCANNED reports" >> $GITHUB_STEP_SUMMARY
          echo "- Discovered: $DISCOVERED candidates" >> $GITHUB_STEP_SUMMARY
          echo "- Issues created: $CREATED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CREATED" -gt 0 ]; then
            echo "### âœ… New Reports Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep "âœ“ Created issue:" discovery_output.log | sed 's/.*âœ“ Created issue: /- /' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: discovery-log-${{ github.run_id }}
          path: discovery_output.log
          retention-days: 7