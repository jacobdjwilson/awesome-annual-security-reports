name: Security Report Discovery

on:
  schedule:
    # Runs at 8:00 AM ET (13:00 UTC) every day
    - cron: '0 13 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  discover:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: pip install google-api-python-client

      - name: Run Discovery
        env:
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: python
        run: |
          import os
          import re
          import json
          import datetime
          from googleapiclient.discovery import build

          # 1. Configuration
          SEARCH_LIMIT = 10 # Stay within daily API limits
          LOOKBACK_DAYS = 90
          
          # 2. Extract targets from README
          # Pattern: - [Org](link) - [Title](link) (Year)
          pattern = r'-\s*\[([^\]]+)\]\([^\)]+\)\s*-\s*\[([^\]]+)\]\([^\)]+\)\s*\((\d{4})\)'
          with open("README.md", "r", encoding="utf-8") as f:
              entries = re.findall(pattern, f.read())

          # Rolling window based on day of year for optimal coverage
          day_of_year = datetime.date.today().timetuple().tm_yday
          start_idx = (day_of_year * SEARCH_LIMIT) % len(entries)
          batch = (entries + entries)[start_idx : start_idx + SEARCH_LIMIT]

          service = build("customsearch", "v1", developerKey=os.environ["GOOGLE_SEARCH_API_KEY"])
          since_date = (datetime.date.today() - datetime.timedelta(days=LOOKBACK_DAYS)).isoformat()

          for org, title, year in batch:
              next_year = int(year) + 1
              # Query for BOTH landing pages and direct PDFs
              search_query = f'"{org}" "{title}" {next_year}'
              
              # 3. Precise Duplicate Check (Stateless)
              # Checks for the Org + Year + Label in issues from the last 90 days
              check_q = f'"{org}" "{next_year}" label:report-suggestion created:>{since_date}'
              exists = os.popen(f'gh issue list --state all --search {json.dumps(check_q)} --json number').read()
              
              if json.loads(exists):
                  print(f"Skipping {org} {next_year}: Recent issue exists.")
                  continue

              # 4. Search and Validate
              try:
                  res = service.cse().list(q=search_query, cx=os.environ["GOOGLE_CSE_ID"], num=3).execute()
                  items = res.get('items', [])
                  
                  for item in items:
                      link = item['link']
                      snippet = item.get('snippet', '')
                      
                      # Validation: Must contain the next year in title or snippet
                      if str(next_year) in item['title'] or str(next_year) in snippet:
                          
                          # 5. Create Issue in Template Format
                          # Values are mapped to the report-suggestion.yml fields
                          issue_title = f"[REPORT SUGGESTION]: {org} ({next_year})"
                          issue_body = (
                              f"### Report URL\n{link}\n\n"
                              f"### Report Year\n{next_year}\n\n"
                              f"### Description\nAutomated discovery found a potential update.\n\n"
                              f"**Snippet from Google:**\n> {snippet}"
                          )
                          
                          # Create issue using GH CLI
                          os.system(f'gh issue create --title {json.dumps(issue_title)} --body {json.dumps(issue_body)} --label "report-suggestion"')
                          print(f"Created suggestion for {org} {next_year}")
                          break 
                          
              except Exception as e:
                  print(f"Search failed for {org}: {e}")