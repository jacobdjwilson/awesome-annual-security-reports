name: Repository Integrity Validator

on:
  schedule:
    # Run every Monday at 8:00 AM ET
    - cron: '0 13 * * 1'
  workflow_dispatch:
    inputs:
      wait_for_pipelines:
        description: 'Wait for running pipelines to complete before validation'
        required: false
        default: 'true'
        type: boolean
      max_wait_minutes:
        description: 'Maximum time to wait for pipelines (minutes)'
        required: false
        default: '30'
        type: number
  # Triggered after Security Reports Pipeline completes
  workflow_run:
    workflows: ["Security Reports Processing Pipeline"]
    types: [completed]
    branches: [main]
  # Manual trigger on push (with delay)
  push:
    paths:
      - 'Annual Security Reports/**'
      - 'Markdown Conversions/**'

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  # Job 1: Wait for any running pipelines to complete
  wait-for-pipelines:
    runs-on: ubuntu-latest
    outputs:
      should_validate: ${{ steps.check_pipelines.outputs.should_validate }}
      pipelines_completed: ${{ steps.wait.outputs.all_completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if we should wait for pipelines
        id: check_pipelines
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine if we should wait based on trigger and inputs
          SHOULD_WAIT="true"
          
          # Don't wait if explicitly disabled
          if [ "${{ github.event.inputs.wait_for_pipelines }}" == "false" ]; then
            SHOULD_WAIT="false"
            echo "Pipeline wait disabled via input"
          fi
          
          # Don't wait if triggered by workflow_run (pipeline already completed)
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            SHOULD_WAIT="false"
            echo "Triggered by workflow_run - pipeline already completed"
          fi
          
          # Don't wait for scheduled runs (they run at off-peak times)
          if [ "${{ github.event_name }}" == "schedule" ]; then
            SHOULD_WAIT="false"
            echo "Scheduled run - assuming no active pipelines"
          fi
          
          echo "should_wait=$SHOULD_WAIT" >> $GITHUB_OUTPUT
          echo "should_validate=true" >> $GITHUB_OUTPUT

      - name: Wait for running Security Reports Pipelines
        id: wait
        if: steps.check_pipelines.outputs.should_wait == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAX_WAIT_SECONDS=${{ github.event.inputs.max_wait_minutes || 30 }}
          MAX_WAIT_SECONDS=$((MAX_WAIT_SECONDS * 60))
          START_TIME=$(date +%s)
          WAIT_INTERVAL=30  # Check every 30 seconds
          
          echo "â³ Checking for running Security Reports Processing Pipeline workflows..."
          echo "Maximum wait time: $((MAX_WAIT_SECONDS / 60)) minutes"
          echo ""
          
          while true; do
            # Get currently running workflows for the Security Reports Pipeline
            RUNNING_WORKFLOWS=$(gh run list \
              --workflow="security-reports-pipeline.yml" \
              --status="in_progress" \
              --json databaseId,status,createdAt,event \
              --limit 10)
            
            RUNNING_COUNT=$(echo "$RUNNING_WORKFLOWS" | jq 'length')
            
            if [ "$RUNNING_COUNT" -eq 0 ]; then
              echo "âœ… No running pipelines found. Proceeding with validation."
              echo "all_completed=true" >> $GITHUB_OUTPUT
              break
            fi
            
            # Check if we've exceeded max wait time
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ $ELAPSED -ge $MAX_WAIT_SECONDS ]; then
              echo "âš ï¸  Maximum wait time reached ($((MAX_WAIT_SECONDS / 60)) minutes)"
              echo "Still running: $RUNNING_COUNT pipeline(s)"
              echo "Proceeding with validation anyway..."
              echo "all_completed=false" >> $GITHUB_OUTPUT
              break
            fi
            
            # Show status
            REMAINING=$((MAX_WAIT_SECONDS - ELAPSED))
            echo "â³ Waiting for $RUNNING_COUNT pipeline(s) to complete..."
            echo "   Time remaining: $((REMAINING / 60)) minutes $((REMAINING % 60)) seconds"
            
            # Show details of running workflows
            echo "$RUNNING_WORKFLOWS" | jq -r '.[] | "   - Run #\(.databaseId) (started: \(.createdAt), event: \(.event))"'
            echo ""
            
            # Wait before checking again
            sleep $WAIT_INTERVAL
          done

      - name: Summary of Pipeline Wait
        if: steps.check_pipelines.outputs.should_wait == 'true'
        run: |
          echo "## â³ Pipeline Wait Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.wait.outputs.all_completed }}" == "true" ]; then
            echo "âœ… All Security Reports Processing Pipelines completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "Validation will run on the latest repository state" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some pipelines may still be running" >> $GITHUB_STEP_SUMMARY
            echo "Validation proceeding anyway after timeout" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Run the actual validation
  validate-repo:
    runs-on: ubuntu-latest
    needs: wait-for-pipelines
    if: needs.wait-for-pipelines.outputs.should_validate == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch latest changes in case pipelines committed updates
          ref: ${{ github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "pypdf[crypto]"

      - name: Run Validation Script
        id: validator
        continue-on-error: true
        run: |
          python .github/scripts/validate-repository.py \
            --pdf-root "Annual Security Reports" \
            --md-root "Markdown Conversions" \
            --output-report validation_report.md

      - name: Upload Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation_report.md
          retention-days: 30

      # --- FAILURE PATH: Check for Existing Issue ---
      - name: Check for Existing Issue
        id: check_issue
        if: steps.validator.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Search for an open issue with the specific label and title
          existing_issue=$(gh issue list \
            --search "Repository Consistency Check Failed in:title" \
            --state open \
            --label "automated-check" \
            --json number \
            --jq '.[0].number')

          if [ -z "$existing_issue" ]; then
            echo "No existing issue found. A new one will be created."
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "Found open issue #$existing_issue. It will be updated."
            echo "issue_number=$existing_issue" >> $GITHUB_OUTPUT
          fi

      # --- FAILURE PATH: Create OR Update Issue ---
      - name: Create or Update Issue
        if: steps.validator.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "âš ï¸ Repository Consistency Check Failed"
          content-filepath: validation_report.md
          issue-number: ${{ steps.check_issue.outputs.issue_number }}
          labels: |
            maintenance
            automated-check
          assignees: jacobdjwilson

      # --- SUCCESS PATH: Close Previous Issues ---
      - name: Close Fixed Issues
        if: steps.validator.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find issues with the specific label and title
          issues=$(gh issue list \
            --state open \
            --label "automated-check" \
            --search "Repository Consistency Check Failed" \
            --json number \
            --jq '.[].number')
          
          if [ -z "$issues" ]; then
            echo "No open validation issues found."
          else
            for issue in $issues; do
              echo "Closing fixed issue #$issue"
              gh issue close "$issue" \
                --comment "âœ… All validation checks passed in run #${{ github.run_id }}. Repository integrity restored."
            done
          fi

      - name: Generate Validation Summary
        if: always()
        run: |
          echo "## ðŸ” Repository Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.wait-for-pipelines.outputs.pipelines_completed }}" == "true" ]; then
            echo "**Pipeline Wait:** âœ… All pipelines completed before validation" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.wait-for-pipelines.outputs.pipelines_completed }}" == "false" ]; then
            echo "**Pipeline Wait:** âš ï¸ Timeout reached, some pipelines may still be running" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Pipeline Wait:** â­ï¸ Skipped (not required for this trigger)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validator.outcome }}" == "success" ]; then
            echo "### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "Repository structure is consistent and all files are properly paired." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Issues detected in repository structure. Check the validation report for details." >> $GITHUB_STEP_SUMMARY
            
            if [ -f validation_report.md ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>ðŸ“‹ Validation Report Preview</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              head -n 50 validation_report.md >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full validation report available in artifacts" >> $GITHUB_STEP_SUMMARY
          
      # Fail the workflow visually if validation failed
      - name: Set Workflow Status
        if: steps.validator.outcome == 'failure'
        run: |
          echo "::error::Repository validation failed. See validation report for details."
          exit 1