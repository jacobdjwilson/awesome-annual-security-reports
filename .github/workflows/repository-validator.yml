name: Repository Integrity Validator

on:
  # Fires whenever either processing pipeline completes.
  # A gate job below blocks validation until BOTH pipelines are idle,
  # preventing false-positive findings from half-written files.
  workflow_run:
    workflows:
      - "Security Reports Processing Pipeline"
      - "Refresh Old Conversions"
    types: [completed]
    branches: [main]

  # Manual trigger
  workflow_dispatch:
    inputs:
      force_validation:
        description: 'Force validation even if no files changed'
        required: false
        default: false
        type: boolean

  # Weekly scheduled validation (Monday 8 AM ET)
  schedule:
    - cron: '0 13 * * 1'

permissions:
  contents: read
  issues: write

jobs:
  # ============================================================
  # GATE JOB
  # Checks whether both monitored pipelines have finished on this
  # SHA before allowing the validation job to proceed.
  # This eliminates race conditions where validation sees partially
  # written files during an active pipeline run.
  # ============================================================
  gate:
    runs-on: ubuntu-latest
    outputs:
      proceed:     ${{ steps.gate.outputs.proceed }}
      skip_reason: ${{ steps.gate.outputs.skip_reason }}
      trigger_sha: ${{ steps.gate.outputs.trigger_sha }}

    steps:
      - name: Check pipeline gate
        id: gate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"
          REPO="${{ github.repository }}"

          # ‚îÄ‚îÄ Manual / scheduled runs always proceed immediately ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if [ "$EVENT" == "workflow_dispatch" ] || [ "$EVENT" == "schedule" ]; then
            echo "proceed=true"                         >> $GITHUB_OUTPUT
            echo "skip_reason="                         >> $GITHUB_OUTPUT
            echo "trigger_sha=${{ github.sha }}"        >> $GITHUB_OUTPUT
            echo "‚úì Manual/scheduled ‚Äî proceeding"
            exit 0
          fi

          # ‚îÄ‚îÄ workflow_run trigger ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          TRIGGER_SHA="${{ github.event.workflow_run.head_sha }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "Triggered by: ${{ github.event.workflow_run.name }}"
          echo "Conclusion:   $CONCLUSION"
          echo "Head SHA:     $TRIGGER_SHA"
          echo ""

          # Skip if the triggering workflow itself did not succeed
          if [ "$CONCLUSION" != "success" ]; then
            echo "proceed=false"                          >> $GITHUB_OUTPUT
            echo "skip_reason=pipeline_did_not_succeed"   >> $GITHUB_OUTPUT
            echo "trigger_sha=$TRIGGER_SHA"               >> $GITHUB_OUTPUT
            echo "‚äò Triggering workflow did not succeed ‚Äî skipping"
            exit 0
          fi

          # ‚îÄ‚îÄ Check whether sibling pipelines are still running ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          # Query in_progress / queued / waiting runs for each monitored
          # workflow on this exact SHA. If any are active, defer validation.
          MONITORED_WORKFLOWS=(
            "Security Reports Processing Pipeline"
            "Refresh Old Conversions"
          )

          BUSY=false
          for WF_NAME in "${MONITORED_WORKFLOWS[@]}"; do
            echo "Checking: $WF_NAME"

            # URL-encode the workflow name for the API query
            ENCODED=$(python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1]))" "$WF_NAME")

            for STATUS in in_progress queued waiting; do
              COUNT=$(gh api \
                "repos/$REPO/actions/workflows/$ENCODED/runs?head_sha=$TRIGGER_SHA&status=$STATUS" \
                --jq '.total_count' 2>/dev/null || echo "0")
              echo "  $STATUS: ${COUNT:-0}"
              if [ "${COUNT:-0}" -gt 0 ]; then
                BUSY=true
                break 2
              fi
            done
          done
          echo ""

          if [ "$BUSY" == "true" ]; then
            echo "proceed=false"                     >> $GITHUB_OUTPUT
            echo "skip_reason=pipelines_still_running" >> $GITHUB_OUTPUT
            echo "trigger_sha=$TRIGGER_SHA"          >> $GITHUB_OUTPUT
            echo "‚äò A monitored pipeline is still running ‚Äî deferring validation"
            echo "  The validator will run again when the other pipeline finishes."
            exit 0
          fi

          # ‚îÄ‚îÄ Check whether relevant files changed on this SHA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          CHANGED=$(gh api \
            "repos/$REPO/commits/$TRIGGER_SHA" \
            --jq '[.files[].filename | select(startswith("Annual Security Reports/") or startswith("Markdown Conversions/"))] | length' \
            2>/dev/null || echo "-1")

          echo "Files changed in monitored directories: ${CHANGED}"

          if [ "${CHANGED}" == "0" ]; then
            echo "proceed=false"                  >> $GITHUB_OUTPUT
            echo "skip_reason=no_relevant_changes" >> $GITHUB_OUTPUT
            echo "trigger_sha=$TRIGGER_SHA"        >> $GITHUB_OUTPUT
            echo "‚äò No changes in monitored directories ‚Äî skipping"
            exit 0
          fi

          echo "proceed=true"             >> $GITHUB_OUTPUT
          echo "skip_reason="             >> $GITHUB_OUTPUT
          echo "trigger_sha=$TRIGGER_SHA" >> $GITHUB_OUTPUT
          echo "‚úì Gate passed ‚Äî proceeding with validation"

  # ============================================================
  # VALIDATE JOB
  # Runs only when the gate gives the green light.
  # Job itself always exits green unless the Python script crashes.
  # Validation findings are handled via GitHub Issues, not job failure.
  # ============================================================
  validate-repository:
    needs: gate
    if: needs.gate.outputs.proceed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --break-system-packages "pypdf[crypto]"

      - name: Run validation
        id: validator
        run: |
          # The script exits 0 for any result including validation findings.
          # It exits 1 only for fatal script-level errors (e.g. missing config).
          python .github/scripts/validate-repository.py \
            --artifacts-dir .github/artifacts \
            --output-report validation_report.md \
            --output-findings validation_findings.json
          echo "script_ok=true" >> $GITHUB_OUTPUT

      - name: Parse findings
        id: findings
        run: |
          if [ ! -f validation_findings.json ]; then
            echo "has_findings=false" >> $GITHUB_OUTPUT
            echo "error_count=0"      >> $GITHUB_OUTPUT
            echo "warning_count=0"    >> $GITHUB_OUTPUT
            echo "fingerprints="      >> $GITHUB_OUTPUT
            exit 0
          fi

          HAS=$(jq -r '.has_findings'  validation_findings.json)
          ERRS=$(jq -r '.error_count'  validation_findings.json)
          WARNS=$(jq -r '.warning_count' validation_findings.json)
          # Fingerprints joined with ';' as the outer list separator.
          # Each fingerprint is "category:file/path" ‚Äî inner sep is ':' (safe: no colons
          # in category names or Linux paths). Outer sep ';' is also safe (no ; in paths).
          # Using | for BOTH inner and outer was ambiguous and caused each token to split.
          FPS=$(jq -r '.fingerprints[]' validation_findings.json | sort | paste -sd ';' -)

          echo "has_findings=$HAS"    >> $GITHUB_OUTPUT
          echo "error_count=$ERRS"    >> $GITHUB_OUTPUT
          echo "warning_count=$WARNS" >> $GITHUB_OUTPUT
          echo "fingerprints=$FPS"    >> $GITHUB_OUTPUT

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_id }}
          path: |
            validation_report.md
            validation_findings.json
          retention-days: 30
          if-no-files-found: ignore

      # ‚îÄ‚îÄ Issue management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      #
      # Deduplication logic uses fingerprints (category|file strings) that
      # are embedded as a hidden HTML comment in the issue body.
      # This allows the workflow to compute a precise diff:
      #   ‚Ä¢ New findings     ‚Üí present in current run, absent from open issue
      #   ‚Ä¢ Resolved items   ‚Üí present in open issue, absent from current run
      #   ‚Ä¢ Unchanged        ‚Üí identical fingerprint sets ‚Üí no update (no spam)
      #
      # Flow:
      #   has_findings=false + no open issue  ‚Üí no-op
      #   has_findings=false + open issue     ‚Üí close with resolution summary
      #   has_findings=true  + no open issue  ‚Üí open new issue
      #   has_findings=true  + open issue
      #     fingerprints unchanged            ‚Üí no update (no spam)
      #     fingerprints changed              ‚Üí close old, open new with diff
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      - name: Find existing open validation issue
        id: find_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULT=$(gh issue list \
            --state open \
            --label "automated-check" \
            --search "Repository Integrity Validation in:title" \
            --json number,body \
            --jq '.[0] // empty')

          if [ -z "$RESULT" ]; then
            echo "issue_number="       >> $GITHUB_OUTPUT
            echo "issue_fingerprints=" >> $GITHUB_OUTPUT
            echo "No existing open validation issue found"
          else
            NUM=$(echo "$RESULT" | jq -r '.number')
            BODY=$(echo "$RESULT" | jq -r '.body // ""')
            # Extract fingerprints from the hidden comment we embed
            FPS=$(echo "$BODY" | grep -oP '(?<=<!-- fingerprints: )[^>]+(?= -->)' || true)
            echo "issue_number=$NUM"       >> $GITHUB_OUTPUT
            echo "issue_fingerprints=$FPS" >> $GITHUB_OUTPUT
            echo "Found existing issue #$NUM (fingerprints: ${FPS:-none})"
          fi

      - name: Manage GitHub issue
        id: issue_mgmt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPO="${{ github.repository }}"
          SHA="${{ needs.gate.outputs.trigger_sha }}"
          SHORT_SHA="${SHA:0:7}"

          HAS_FINDINGS="${{ steps.findings.outputs.has_findings }}"
          ERRS="${{ steps.findings.outputs.error_count }}"
          WARNS="${{ steps.findings.outputs.warning_count }}"
          CURRENT_FPS="${{ steps.findings.outputs.fingerprints }}"

          EXISTING_NUM="${{ steps.find_issue.outputs.issue_number }}"
          PREVIOUS_FPS="${{ steps.find_issue.outputs.issue_fingerprints }}"

          # ‚îÄ‚îÄ Helper: set diff on semicolon-delimited fingerprint strings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          # Fingerprints are "category:file/path" joined with ';' as list sep.
          # Split on ';' ‚Äî unambiguous since Linux paths never contain ';'.
          fps_diff_new() {
            local cur="${1:-}" prv="${2:-}"
            [ -z "$cur" ] && return
            local IFS=';'
            read -ra CUR_ARR <<< "$cur"
            read -ra PRV_ARR <<< "$prv"
            for fp in "${CUR_ARR[@]}"; do
              [ -z "$fp" ] && continue
              local found=false
              for p in "${PRV_ARR[@]}"; do
                [ "$fp" == "$p" ] && found=true && break
              done
              $found || printf '%s\n' "$fp"
            done
          }

          fps_diff_resolved() {
            fps_diff_new "${2:-}" "${1:-}"
          }

          # ‚îÄ‚îÄ Case 1: clean run, no open issue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if [ "$HAS_FINDINGS" != "true" ] && [ -z "$EXISTING_NUM" ]; then
            echo "‚úÖ Clean ‚Äî no action needed"
            echo "action=none" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ‚îÄ‚îÄ Case 2: clean run, existing issue ‚Üí close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if [ "$HAS_FINDINGS" != "true" ] && [ -n "$EXISTING_NUM" ]; then
            COMMIT_URL="https://github.com/$REPO/commit/$SHA"
            # Use printf to avoid heredoc leading-space indentation issues
            {
              printf '## ‚úÖ All Issues Resolved\n\n'
              printf 'Repository validation passed with no findings.\n\n'
              printf '| Detail | Value |\n'
              printf '|--------|-------|\n'
              printf '| Run | [#%s](%s) |\n' "${{ github.run_id }}" "$RUN_URL"
              printf '| Commit | [`%s`](%s) |\n' "$SHORT_SHA" "$COMMIT_URL"
              printf '| Timestamp | %s |\n' "$(date -u +"%Y-%m-%d %H:%M UTC")"
              printf '\nAll previously reported integrity issues have been addressed. Closing this ticket.\n'
            } > /tmp/resolution.md

            gh issue close "$EXISTING_NUM" --comment "$(cat /tmp/resolution.md)"
            echo "‚úì Closed issue #$EXISTING_NUM ‚Äî all resolved"
            echo "action=closed"              >> $GITHUB_OUTPUT
            echo "closed_issue=$EXISTING_NUM" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ‚îÄ‚îÄ Case 3: has findings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          NEW_FPS=$(fps_diff_new "$CURRENT_FPS" "$PREVIOUS_FPS")
          RES_FPS=$(fps_diff_resolved "$CURRENT_FPS" "$PREVIOUS_FPS")

          echo "New findings:      ${NEW_FPS:-none}"
          echo "Resolved findings: ${RES_FPS:-none}"

          # Fingerprints unchanged ‚Üí suppress duplicate issue (no spam)
          if [ -n "$EXISTING_NUM" ] && [ -z "$NEW_FPS" ] && [ -z "$RES_FPS" ]; then
            echo "‚äò Findings identical to open issue #$EXISTING_NUM ‚Äî no update"
            echo "action=unchanged"              >> $GITHUB_OUTPUT
            echo "unchanged_issue=$EXISTING_NUM" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build new issue body.
          # Embedded fingerprint comment is extracted on the next run for deduplication.
          COMMIT_URL="https://github.com/$REPO/commit/$SHA"
          {
            printf '## ‚ö†Ô∏è Repository Integrity Issues Detected\n\n'
            printf 'The automated repository validator found issues that require attention.\n\n'
            printf '| Detail | Value |\n'
            printf '|--------|-------|\n'
            printf '| Workflow Run | [#%s](%s) |\n' "${{ github.run_id }}" "$RUN_URL"
            printf '| Commit | [`%s`](%s) |\n' "$SHORT_SHA" "$COMMIT_URL"
            printf '| Trigger | `%s` |\n' "${{ github.event_name }}"
            printf '| Timestamp | %s |\n' "$(date -u +"%Y-%m-%d %H:%M UTC")"
            printf '| Errors | **%s** |\n' "$ERRS"
            printf '| Warnings | **%s** |\n' "$WARNS"
            printf '\n---\n\n'
            cat validation_report.md
            printf '\n---\n'
            printf '<!-- fingerprints: %s -->\n' "$CURRENT_FPS"
          } > /tmp/new_issue_body.md

          # If an existing issue is open, close it with a diff summary first
          if [ -n "$EXISTING_NUM" ]; then
            {
              printf '## üîÑ Superseded by New Validation Run\n\n'
              printf 'This issue is being replaced because the finding set changed.\n\n'
              if [ -n "$RES_FPS" ]; then
                printf '### ‚úÖ Resolved since last check\n\n'
                while IFS= read -r fp; do
                  [ -z "$fp" ] && continue
                  printf -- '- `%s`\n' "$fp"
                done <<< "$RES_FPS"
                printf '\n'
              fi
              if [ -n "$NEW_FPS" ]; then
                printf '### üÜï New findings\n\n'
                while IFS= read -r fp; do
                  [ -z "$fp" ] && continue
                  printf -- '- `%s`\n' "$fp"
                done <<< "$NEW_FPS"
                printf '\n'
              fi
              printf 'Workflow Run: [#%s](%s)\n' "${{ github.run_id }}" "$RUN_URL"
            } > /tmp/close_comment.md

            gh issue close "$EXISTING_NUM" --comment "$(cat /tmp/close_comment.md)"
            echo "‚úì Closed stale issue #$EXISTING_NUM"
          fi

          # Create fresh issue.
          # NOTE: 'gh issue create' does NOT support --json or --jq flags.
          # It outputs the new issue URL to stdout ‚Äî extract the number from it.
          NEW_URL=$(gh issue create \
            --title "‚ö†Ô∏è Repository Integrity Validation ‚Äî Issues Found" \
            --body-file /tmp/new_issue_body.md \
            --label "maintenance,automated-check" \
            --assignee jacobdjwilson)

          NEW_NUM=$(echo "$NEW_URL" | grep -oE '[0-9]+$')

          echo "‚úì Created issue #$NEW_NUM ($NEW_URL)"
          echo "action=created"     >> $GITHUB_OUTPUT
          echo "new_issue=$NEW_NUM" >> $GITHUB_OUTPUT
      - name: Generate step summary
        if: always()
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          HAS="${{ steps.findings.outputs.has_findings }}"
          ERRS="${{ steps.findings.outputs.error_count }}"
          WARNS="${{ steps.findings.outputs.warning_count }}"
          ACTION="${{ steps.issue_mgmt.outputs.action }}"
          NEW_ISSUE="${{ steps.issue_mgmt.outputs.new_issue }}"
          CLOSED_ISSUE="${{ steps.issue_mgmt.outputs.closed_issue }}"
          UNCHANGED_ISSUE="${{ steps.issue_mgmt.outputs.unchanged_issue }}"
          REPO="${{ github.repository }}"

          echo "## üìã Repository Integrity Validator" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | [#${{ github.run_id }}]($RUN_URL) |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ needs.gate.outputs.trigger_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${ERRS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Warnings | ${WARNS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${HAS:-false}" != "true" ]; then
            echo "### ‚úÖ Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All PDF ‚Üî Markdown pairs are consistent, correctly named, and structurally valid." >> $GITHUB_STEP_SUMMARY
            if [ -n "$CLOSED_ISSUE" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚úÖ Closed previously open issue [#$CLOSED_ISSUE](https://github.com/$REPO/issues/$CLOSED_ISSUE) ‚Äî all issues resolved." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ö†Ô∏è Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "$NEW_ISSUE" ]; then
              echo "Opened issue [#$NEW_ISSUE](https://github.com/$REPO/issues/$NEW_ISSUE) with full details." >> $GITHUB_STEP_SUMMARY
            elif [ -n "$UNCHANGED_ISSUE" ]; then
              echo "Findings unchanged ‚Äî no update to open issue [#$UNCHANGED_ISSUE](https://github.com/$REPO/issues/$UNCHANGED_ISSUE)." >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>üìÑ Validation Report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat validation_report.md 2>/dev/null || echo "(report not available)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìé Full report available in [workflow artifacts]($RUN_URL)." >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # SKIPPED SUMMARY JOB
  # Runs when the gate decided to skip ‚Äî produces a clean green
  # run with an informative summary instead of a blank/red job.
  # ============================================================
  skipped-summary:
    needs: gate
    if: needs.gate.outputs.proceed != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Generate skip summary
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REASON="${{ needs.gate.outputs.skip_reason }}"

          echo "## üìã Repository Integrity Validator" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | [#${{ github.run_id }}]($RUN_URL) |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | \`${{ needs.gate.outputs.trigger_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚äò Validation Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "$REASON" in
            pipeline_did_not_succeed)
              echo "The triggering pipeline did not complete successfully ‚Äî validation skipped to avoid acting on a broken or partial state." >> $GITHUB_STEP_SUMMARY
              ;;
            pipelines_still_running)
              echo "One or more monitored pipelines are still running on this commit." >> $GITHUB_STEP_SUMMARY
              echo "Validation will run automatically when they finish." >> $GITHUB_STEP_SUMMARY
              ;;
            no_relevant_changes)
              echo "No files changed in \`Annual Security Reports/\` or \`Markdown Conversions/\` ‚Äî nothing to validate." >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "Validation was not required for this run." >> $GITHUB_STEP_SUMMARY
              ;;
          esac