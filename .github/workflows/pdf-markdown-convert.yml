name: ‚öôÔ∏è PDF to Markdown Conversion

on:
  workflow_run:
    workflows: ["üõ°Ô∏è VirusTotal Security Scan"]
    types:
      - completed
  workflow_dispatch:

jobs:
  convert-pdf-to-markdown:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ‚úÖ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install 'markitdown[pdf]' google-generativeai google-api-python-client
      
      - name: üîç Find new and modified PDF files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: 'Annual Security Reports/**/*.pdf'
          separator: "\n"

      - name: üìÇ Download VirusTotal Results Artifact
        if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
        uses: actions/download-artifact@v4
        with:
          name: virustotal_results
          path: .
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Verify prompt file exists
        id: check-prompt
        run: |
          PROMPT_PATH=".github/ai-prompts/pdf-to-markdown-prompt.md"
          if [ -f "$PROMPT_PATH" ]; then
            echo "prompt_exists=true" >> $GITHUB_OUTPUT
            echo "Found prompt file at $PROMPT_PATH"
            PROMPT_VERSION=$(git log -n 1 --pretty=format:"%s" -- "$PROMPT_PATH" | grep -oP 'v\d+\.\d+(\.\d+)?' || echo "v1.0")
            echo "prompt_version=$PROMPT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "prompt_exists=false" >> $GITHUB_OUTPUT
            echo "Prompt file not found at $PROMPT_PATH"
          fi
      
      - name: ü§ñ Process PDF files
        if: steps.changed-files.outputs.any_changed == 'true' && steps.check-prompt.outputs.prompt_exists == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
          PROMPT_VERSION: ${{ steps.check-prompt.outputs.prompt_version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
          CONVERTED_REPORTS_JSON_PATH: "converted_reports.json"
          VIRUSTOTAL_RESULTS_JSON_PATH: "virustotal_results.json" # Pass path to VT results
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "$CHANGED_FILES" > changed_files.txt
          python ./.github/scripts/pdf-converter.py changed_files.txt ".github/ai-prompts/pdf-to-markdown-prompt.md" "$PROMPT_VERSION" "$BRANCH" "$VIRUSTOTAL_RESULTS_JSON_PATH"
          git pull --rebase origin ${{ github.ref_name }}
          git push https://${{ secrets.GITHUB_ACTOR }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
      
      - name: Upload converted reports info
        if: steps.changed-files.outputs.any_changed == 'true' && steps.check-prompt.outputs.prompt_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: converted_file_info
          path: converted_reports.json
          retention-days: 1
      
      - name: ‚ùå Error - Prompt file missing
        if: steps.changed-files.outputs.any_changed == 'true' && steps.check-prompt.outputs.prompt_exists != 'true'
        run: |
          echo "Error: Prompt file not found at .github/ai-prompts/pdf-to-markdown-prompt.md"
          echo "Please ensure the prompt file exists in your repository."
          exit 1