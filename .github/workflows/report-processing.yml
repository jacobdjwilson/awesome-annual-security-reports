name: Report Processing Orchestrator

on:
  push:
    branches:
      - main
      - development
    paths:
      - 'Annual Security Reports/**/*.pdf'
  workflow_dispatch:

jobs:
  find-new-pdfs:
    runs-on: ubuntu-latest
    outputs:
      new_pdfs: ${{ steps.check.outputs.new_pdfs }}
    steps:
      - name: ðŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Find Newly Added PDF Files
        id: check
        run: |
          RAW_PDFS=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} | grep 'Annual Security Reports/.*\.pdf')
          echo "DEBUG: Raw PDFs found: $RAW_PDFS"
          
          if [ -z "$RAW_PDFS" ]; then
            ADDED_PDFS="[]"
            echo "â„¹ï¸ No new PDF files detected. Setting new_pdfs to empty JSON array."
          else
            # Convert each line to a JSON string and then combine into a JSON array
            ADDED_PDFS=$(echo "$RAW_PDFS" | jq -R -s 'split("\n") | map(select(length > 0))')
            echo "âœ… New PDF files detected: $ADDED_PDFS"
          fi
          echo "DEBUG: Final new_pdfs output: $ADDED_PDFS"
          echo "new_pdfs=$ADDED_PDFS" >> $GITHUB_OUTPUT

  virus-total-scan:
    needs: find-new-pdfs
    if: ${{ needs.find-new-pdfs.outputs.new_pdfs != '[]' }}
    strategy:
      matrix:
        pdf_file: ${{ fromJson(needs.find-new-pdfs.outputs.new_pdfs) }}
    uses: ./.github/workflows/virus-total-scan.yml
    secrets: inherit
    with:
      pdf_file_path: ${{ matrix.pdf_file }}
      retries: 3

  pdf-to-markdown:
    needs: virus-total-scan
    if: ${{ needs.find-new-pdfs.outputs.new_pdfs != '[]' }}
    strategy:
      matrix:
        pdf_file: ${{ fromJson(needs.find-new-pdfs.outputs.new_pdfs) }}
    uses: ./.github/workflows/pdf-markdown-convert.yml
    secrets: inherit
    with:
      pdf_file_path: ${{ matrix.pdf_file }}
      retries: 3

  update-readme:
    needs: pdf-to-markdown
    if: ${{ needs.find-new-pdfs.outputs.new_pdfs != '[]' }}
    uses: ./.github/workflows/readme-entry.yml
    secrets: inherit
