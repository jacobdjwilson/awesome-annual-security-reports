name: Report Processing Orchestrator

on:
  push:
    branches:
      - main
      - development
    paths:
      - 'Annual Security Reports/**/*.pdf'
  workflow_dispatch:

jobs:
  check-for-added-pdfs:
    runs-on: ubuntu-latest
    outputs:
      new_pdfs_added: ${{ steps.check.outputs.new_pdfs_added }}
    steps:
      - name: üîç Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìù Check for Added PDF Files
        id: check
        run: |
          ADDED_PDFS=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} | grep 'Annual Security Reports/.*\.pdf')
          if [ -n "$ADDED_PDFS" ]; then
            echo "new_pdfs_added=true" >> $GITHUB_OUTPUT
            echo "‚úÖ New PDF files detected."
          else
            echo "new_pdfs_added=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No new PDF files detected."
          fi

  pdf-to-markdown:
    needs: check-for-added-pdfs
    if: ${{ github.event_name == 'workflow_dispatch' || needs.check-for-added-pdfs.outputs.new_pdfs_added == 'true' }}
    uses: ./.github/workflows/pdf-markdown-convert.yml
    secrets: inherit
    with:
      retries: 3

  virus-total-scan:
    needs: pdf-to-markdown
    if: success() && (github.event_name == 'workflow_dispatch' || needs.check-for-added-pdfs.outputs.new_pdfs_added == 'true')
    uses: ./.github/workflows/virus-total-scan.yml
    secrets: inherit
    with:
      retries: 3

  update-readme:
    needs: [pdf-to-markdown, virus-total-scan]
    if: success() && (github.event_name == 'workflow_dispatch' || needs.check-for-added-pdfs.outputs.new_pdfs_added == 'true')
    uses: ./.github/workflows/readme-entry.yml
    secrets: inherit
