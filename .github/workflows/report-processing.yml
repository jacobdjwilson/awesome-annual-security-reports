name: Report Processing Orchestrator

on:
  push:
    branches:
      - main
      - development
    paths:
      - 'Annual Security Reports/**/*.pdf'
  workflow_dispatch:

jobs:
  find-new-pdfs:
    runs-on: ubuntu-latest
    outputs:
      new_pdfs: ${{ steps.check.outputs.new_pdfs }}
    steps:
      - name: 🔍 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📝 Find Newly Added PDF Files
        id: check
        run: |
          ADDED_PDFS=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} | grep 'Annual Security Reports/.*\.pdf' | jq -c -R -s 'split("\n") | map(select(length > 0))')
          if [ -z "$ADDED_PDFS" ] || [ "$ADDED_PDFS" == "[]" ]; then
            ADDED_PDFS="[]"
            echo "ℹ️ No new PDF files detected."
          else
            echo "✅ New PDF files detected: $ADDED_PDFS"
          fi
          echo "new_pdfs=$ADDED_PDFS" >> $GITHUB_OUTPUT

  virus-total-scan:
    needs: find-new-pdfs
    if: ${{ needs.find-new-pdfs.outputs.new_pdfs != '[]' }}
    strategy:
      matrix:
        pdf_file: ${{ fromJson(needs.find-new-pdfs.outputs.new_pdfs) }}
    uses: ./.github/workflows/virus-total-scan.yml
    secrets: inherit
    with:
      pdf_file_path: ${{ matrix.pdf_file }}
      retries: 3

  pdf-to-markdown:
    needs: virus-total-scan
    if: ${{ needs.find-new-pdfs.outputs.new_pdfs != '[]' }}
    strategy:
      matrix:
        pdf_file: ${{ fromJson(needs.find-new-pdfs.outputs.new_pdfs) }}
    uses: ./.github/workflows/pdf-markdown-convert.yml
    secrets: inherit
    with:
      pdf_file_path: ${{ matrix.pdf_file }}
      retries: 3

  update-readme:
    needs: pdf-to-markdown
    if: ${{ needs.find-new-pdfs.outputs.new_pdfs != '[]' }}
    uses: ./.github/workflows/readme-entry.yml
    secrets: inherit
