name: Refresh Old Conversions

on:
  schedule:
    # Run every day at 8:00 AM ET (12:00 UTC)
    - cron: '0 13 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  identify-stale-files:
    runs-on: ubuntu-latest
    outputs:
      has_files: ${{ steps.check-files.outputs.has_files }}
      file_count: ${{ steps.check-files.outputs.file_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find stale or missing files
        id: check-files
        shell: python
        run: |
          import os
          import subprocess
          import time
          from pathlib import Path

          # Configuration
          MD_ROOT = Path("Markdown Conversions")
          PDF_ROOT = Path("Annual Security Reports")
          LIMIT = 10
          DAYS_OLD = 90
          AGE_LIMIT_SECONDS = DAYS_OLD * 24 * 3600
          
          files_to_process = []
          stale_files = []
          current_time = time.time()

          print("Scanning for missing or stale conversions...")

          # 1. Look for MISSING conversions (PDF exists, MD does not)
          if PDF_ROOT.exists():
              for pdf_file in PDF_ROOT.rglob("*.pdf"):
                  rel_path = pdf_file.relative_to(PDF_ROOT)
                  md_file = MD_ROOT / rel_path.with_suffix('.md')
                  
                  if not md_file.exists():
                      print(f"Found missing conversion: {pdf_file}")
                      # Priority 0 for missing files so they process first
                      files_to_process.append(str(pdf_file))

          # 2. Look for STALE conversions (MD exists but is old)
          if MD_ROOT.exists():
              for md_file in MD_ROOT.rglob("*.md"):
                  try:
                      timestamp_str = subprocess.check_output(
                          ['git', 'log', '-1', '--format=%ct', str(md_file)], 
                          text=True
                      ).strip()
                      
                      if not timestamp_str:
                          continue
                          
                      last_commit_time = int(timestamp_str)
                      age_seconds = current_time - last_commit_time
                      
                      if age_seconds > AGE_LIMIT_SECONDS:
                          rel_path = md_file.relative_to(MD_ROOT)
                          pdf_path = PDF_ROOT / rel_path.with_suffix('.pdf')
                          
                          if pdf_path.exists():
                              stale_files.append((age_seconds, str(pdf_path)))
                  except Exception:
                      continue

          # Sort stale files by age (oldest first) and add to list
          stale_files.sort(key=lambda x: x[0], reverse=True)
          for _, pdf_path in stale_files:
              if pdf_path not in files_to_process:
                  files_to_process.append(pdf_path)

          # Apply global limit
          selected_files = files_to_process[:LIMIT]
          
          print(f"\nSummary: Found {len(files_to_process)} total files needing attention.")
          print(f"Selected {len(selected_files)} for this run.")

          # Output results
          if selected_files:
              with open("files_to_process.txt", "w") as f:
                  f.write("\n".join(selected_files))
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                  fh.write("has_files=true\n")
                  fh.write(f"file_count={len(selected_files)}\n")
          else:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                  fh.write("has_files=false\n")
                  fh.write("file_count=0\n")

      - name: Upload file list
        if: steps.check-files.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: files-to-process
          path: files_to_process.txt
          retention-days: 1

  process-stale-reports:
    needs: identify-stale-files
    if: needs.identify-stale-files.outputs.has_files == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
          python -m pip install --upgrade pip
          pip install markitdown[pdf,ocr] google-generativeai google-api-python-client requests

      - name: Download file list
        uses: actions/download-artifact@v4
        with:
          name: files-to-process
          path: .

      - name: Re-run PDF Converter
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        run: |
          PROMPT_PATH=".github/ai-prompts/pdf-to-markdown-prompt.md"
          python .github/scripts/pdf-converter.py files_to_process.txt "$PROMPT_PATH" "refresh-job" "${{ github.ref_name }}" --output-json conversions.json

      - name: Re-run Report Analyzer
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -f conversions.json ]; then
            python .github/scripts/report-analyzer.py conversions.json --readme-path README.md --output-json analysis.json
          fi

      - name: Update README
        id: readme_update
        run: |
          if [ -f analysis.json ]; then
            if python .github/scripts/readme-updater.py analysis.json --readme-path README.md; then
              if git diff --quiet HEAD -- README.md "Markdown Conversions/"; then
                echo "changes_detected=false" >> $GITHUB_OUTPUT
              else
                echo "changes_detected=true" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Create Pull Request
        if: steps.readme_update.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "♻️ Refresh stale and missing security reports"
          title: "♻️ Sync/Refresh ${{ needs.identify-stale-files.outputs.file_count }} security reports"
          body: |
            ### Automated Report Sync
            
            This workflow identified reports that were either:
            1. **Missing**: PDF exists but no Markdown version was found.
            2. **Stale**: Markdown version is older than 90 days.
            
            **Processed Count:** ${{ needs.identify-stale-files.outputs.file_count }}
          branch: refresh-reports-${{ github.run_id }}
          delete-branch: true
          add-paths: |
            README.md
            Markdown Conversions/
          labels: |
            automated
            maintenance